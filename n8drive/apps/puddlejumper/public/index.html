
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PuddleJumper â€” Governance Engine</title>
  <link rel="stylesheet" href="/styles/pj.css">
</head>
<body>
  <div id="main-content" class="container" tabindex="-1">
    <div class="hero">
      <div class="version-badge">v1.2 Production â€¢ Workspace + RBAC + Metrics</div>
      <h1>ğŸš€ PuddleJumper</h1>
      <p>Governance control plane with workspace isolation, RBAC and tier enforcement, chain approvals, and chain-step observability for operators.</p>
    </div>

    <div class="features">
      <div class="feature-card">
        <div class="icon" aria-hidden="true">ğŸ”</div>
        <h3>Workspace Isolation</h3>
        <p>Each user gets their own secure workspace with complete data isolation and role-based access control.</p>
      </div>
      <div class="feature-card">
        <div class="icon" aria-hidden="true">âš¡</div>
        <h3>Approval Chains</h3>
        <p>Multi-step and parallel approval workflows with deterministic progression, audit trails, and dispatch controls.</p>
      </div>
      <div class="feature-card">
        <div class="icon" aria-hidden="true">ğŸ¯</div>
        <h3>Operational Observability</h3>
        <p>Metrics and runbook-ready signals for queue health, chain-step latency, and stuck-step detection.</p>
      </div>
    </div>

    <div class="actions">
      <a href="/pj/admin" class="btn">ğŸ›ï¸ Open Admin Panel</a>
      <a href="/pj/guide" class="btn secondary">ğŸ“š Quick Start Guide</a>
      <a href="/health" class="btn secondary" target="_blank" rel="noopener noreferrer">ğŸ¥ System Health</a>
    </div>

    <div class="status">
      <strong>Status:</strong> System operational â€¢ Workspace isolation active â€¢ RBAC/tier enforcement enabled
    </div>

    <div class="command-panel">
      <h2>âš¡ Quick Commands</h2>
      <div class="command-card">
        <h3>ğŸ“Š Summarize Dashboard</h3>
        <p>Generate a quick summary of active policies, pending reviews, and violations.</p>
        <button class="command-btn" type="button">Run</button>
        <div class="command-loading">Runningâ€¦</div>
        <div class="command-result" role="status" aria-live="polite"></div>
      </div>
    </div>
  </div>

  <!-- Unified Auth Gate Modal -->
  <div id="auth-gate" class="auth-gate" aria-hidden="true" style="display:none;">
    <div class="auth-gate-card" role="dialog" aria-modal="true" aria-labelledby="authTitle">
      <h2 id="authTitle">Sign in to PuddleJumper</h2>
      <p id="authDesc">Sign in with a provider or paste a JWT token to access the control plane.</p>
      <div style="display:flex;flex-direction:column;gap:12px;margin-bottom:16px;">
        <a href="/api/auth/github/login" style="display:inline-flex;align-items:center;gap:8px;background:#24292e;color:#fff;padding:12px 24px;border-radius:var(--radius);font-size:1rem;font-weight:500;text-decoration:none;font-family:var(--font);transition:all 0.2s;">
          <svg width="20" height="20" viewBox="0 0 16 16" fill="white" aria-hidden="true"><path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"/></svg>
          Sign in with GitHub
        </a>
        <a href="/api/auth/google/login" style="display:inline-flex;align-items:center;gap:8px;background:#fff;color:#222;padding:12px 24px;border-radius:var(--radius);font-size:1rem;font-weight:500;text-decoration:none;font-family:var(--font);border:1px solid #dadce0;box-shadow:0 1px 2px rgba(60,64,67,.08);transition:all 0.2s;">
          <svg width="20" height="20" viewBox="0 0 48 48" aria-hidden="true"><g><path fill="#4285F4" d="M24 9.5c3.54 0 6.36 1.22 8.3 2.97l6.18-6.18C34.64 2.7 29.74 0 24 0 14.82 0 6.73 5.82 2.69 14.09l7.19 5.59C11.27 13.36 17.13 9.5 24 9.5z"/><path fill="#34A853" d="M46.1 24.55c0-1.64-.15-3.22-.42-4.74H24v9.01h12.42c-.54 2.9-2.18 5.36-4.66 7.01l7.19 5.59C43.27 37.27 46.1 31.45 46.1 24.55z"/><path fill="#FBBC05" d="M10.88 28.68a14.5 14.5 0 010-9.36l-7.19-5.59A23.94 23.94 0 000 24c0 3.77.9 7.34 2.69 10.91l7.19-5.59z"/><path fill="#EA4335" d="M24 46c6.48 0 11.92-2.15 15.89-5.86l-7.19-5.59c-2.01 1.35-4.59 2.15-8.7 2.15-6.87 0-12.73-3.86-15.12-9.09l-7.19 5.59C6.73 42.18 14.82 48 24 48z"/><path fill="none" d="M0 0h48v48H0z"/></g></svg>
          Sign in with Google
        </a>
        <a href="/api/auth/microsoft/login" style="display:inline-flex;align-items:center;gap:8px;background:#f3f3f3;color:#2F2F2F;padding:12px 24px;border-radius:var(--radius);font-size:1rem;font-weight:500;text-decoration:none;font-family:var(--font);border:1px solid #e5e5e5;transition:all 0.2s;">
          <svg width="20" height="20" viewBox="0 0 24 24" aria-hidden="true"><g><rect fill="#F25022" x="1" y="1" width="10" height="10"/><rect fill="#7FBA00" x="13" y="1" width="10" height="10"/><rect fill="#00A4EF" x="1" y="13" width="10" height="10"/><rect fill="#FFB900" x="13" y="13" width="10" height="10"/></g></svg>
          Sign in with Microsoft
        </a>
      </div>
      <div style="margin:16px 0 8px 0;font-size:14px;color:var(--text-dim);">
        You only need to log in with one provider. Others can be added as connectors in the app.
      </div>
      <div style="margin:16px 0 8px 0;font-size:14px;color:var(--text-dim);">Or paste a JWT token below:</div>
      <input id="jwtInput" type="password" class="auth-input" placeholder="eyJhbGci..." aria-label="JWT token" autocomplete="off" style="width:100%;padding:10px 14px;margin:12px 0;font-family:var(--font-mono);border:1px solid var(--stone-300);border-radius:6px;">
      <div style="display:flex;gap:8px;">
        <button id="authSubmit" class="btn btn-approve" type="button" style="flex:1">Authenticate</button>
        <button id="authClear" class="btn btn-secondary" type="button" style="flex:1">Clear</button>
      </div>
    </div>
  </div>

  <script src="/scripts/pj-commands.js"></script>
  <script>
    // Unified token key
    const TOKEN_KEY = 'pj_token';

    function getCookie(name) {
      const m = document.cookie.match(new RegExp("(?:^|; )" + name + "=([^;]*)"));
      return m ? decodeURIComponent(m[1]) : null;
    }

    function getStoredToken() {
      return getCookie(TOKEN_KEY) || localStorage.getItem(TOKEN_KEY);
    }

    async function checkAuth() {
      const token = getStoredToken();
      if (!token) {
        showAuthGate();
        return;
      }
      try {
        const res = await fetch("/api/me", {
          headers: { "Authorization": "Bearer " + token },
          credentials: 'include'
        });
        if (res.ok) {
          hideAuthGate();
        } else {
          localStorage.removeItem(TOKEN_KEY);
          showAuthGate();
        }
      } catch (e) {
        console.error('Auth check failed', e);
        showAuthGate();
      }
    }

    function showAuthGate() {
      const gate = document.getElementById("auth-gate");
      const main = document.getElementById("main-content");
      if (!gate || !main) return;
      gate.style.display = "block";
      gate.setAttribute("aria-hidden", "false");
      main.style.display = "none";
      // Focus management
      const firstFocusable = gate.querySelector('input, button, [tabindex]:not([tabindex="-1"])');
      firstFocusable && firstFocusable.focus();
      gate.addEventListener('keydown', trapFocus);
    }

    function hideAuthGate() {
      const gate = document.getElementById("auth-gate");
      const main = document.getElementById("main-content");
      if (!gate || !main) return;
      gate.style.display = "none";
      gate.setAttribute("aria-hidden", "true");
      main.style.display = "block";
      main.focus();
      gate.removeEventListener('keydown', trapFocus);
    }

    function trapFocus(e) {
      if (e.key !== 'Tab') return;
      const gate = document.getElementById('auth-gate');
      const focusables = Array.from(gate.querySelectorAll('a[href], button:not([disabled]), input, select, textarea, [tabindex]:not([tabindex="-1"])'));
      if (!focusables.length) return;
      const first = focusables[0];
      const last = focusables[focusables.length - 1];
      if (e.shiftKey && document.activeElement === first) {
        e.preventDefault();
        last.focus();
      } else if (!e.shiftKey && document.activeElement === last) {
        e.preventDefault();
        first.focus();
      }
    }

    // Close on Escape
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        const gate = document.getElementById('auth-gate');
        if (gate && gate.style.display !== 'none') hideAuthGate();
      }
    });

    // JWT paste auth (demo/ephemeral)
    document.getElementById('authSubmit').addEventListener('click', () => {
      const jwt = document.getElementById('jwtInput').value.trim();
      if (!jwt) return;
      // Store in-memory or localStorage for demo; in production, send to server to set HttpOnly cookie
      localStorage.setItem(TOKEN_KEY, jwt);
      hideAuthGate();
      checkAuth();
    });
    document.getElementById('authClear').addEventListener('click', () => {
      document.getElementById('jwtInput').value = '';
      localStorage.removeItem(TOKEN_KEY);
    });

    // Check auth on page load
    checkAuth();
  </script>
</body>
</html>
