
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PuddleJumper — Control Plane</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600&family=IBM+Plex+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="/styles/pj-admin.css">
</head>
<body>

<!-- Header -->
<div class="header">
  <div class="header-brand">
    <a class="logo" href="/">Puddle<span>Jumper</span></a>
    <div class="sep"></div>
    <div class="subtitle">Control Plane</div>
    <div class="ws-chip" id="ws-chip"></div>
  </div>
  <div class="header-right">
    <div class="auto-ref-badge" id="auto-ref"><div class="dot"></div>Auto</div>
    <a class="header-btn" href="/pj/guide">Guide</a>
    <button class="header-btn" onclick="refresh()" id="refresh-btn">↻ Refresh</button>
  </div>
</div>

<!-- Viewer banner -->
<div class="viewer-banner" id="auth-status">
  <span id="auth-status-text">Checking authentication...</span>
</div>

<!-- Tabs -->
<div class="tabs">
  <button class="tab active" data-tab="queue" onclick="switchTab('queue')">Approval Queue</button>
  <button class="tab" data-tab="chains" onclick="switchTab('chains')">Chain Templates</button>
  <button class="tab" data-tab="dashboard" onclick="switchTab('dashboard')">Dashboard</button>
  <button class="tab" data-tab="prr" onclick="switchTab('prr')">PRR</button>
  <button class="tab" data-tab="members" onclick="switchTab('members')">Members</button>
</div>

<!-- Auth Gate -->
<div id="auth-gate">
  <h2>// sign in required</h2>
  <p>Authentication required to access the control plane.</p>
  <div class="sign-in-card">
    <a href="/api/auth/github/login" class="oauth-btn oauth-github">
      <svg width="18" height="18" viewBox="0 0 16 16" fill="white"><path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"/></svg>
      Sign in with GitHub
    </a>
    <!-- Show Google/Microsoft only when those OAuth providers are configured in env -->
    <a href="/api/auth/google/login" class="oauth-btn oauth-optional" data-provider="google" style="background:#fff;color:#333;border:1px solid #ddd;display:none">
      <svg width="18" height="18" viewBox="0 0 48 48"><path fill="#4285F4" d="M24 9.5c3.54 0 6.36 1.22 8.3 2.97l6.18-6.18C34.64 2.7 29.74 0 24 0 14.82 0 6.73 5.82 2.69 14.09l7.19 5.59C11.27 13.36 17.13 9.5 24 9.5z"/><path fill="#34A853" d="M46.1 24.55c0-1.64-.15-3.22-.42-4.74H24v9.01h12.42c-.54 2.9-2.18 5.36-4.66 7.01l7.19 5.59C43.27 37.27 46.1 31.45 46.1 24.55z"/><path fill="#FBBC05" d="M10.88 28.68a14.5 14.5 0 010-9.36l-7.19-5.59A23.94 23.94 0 000 24c0 3.77.9 7.34 2.69 10.91l7.19-5.59z"/><path fill="#EA4335" d="M24 46c6.48 0 11.92-2.15 15.89-5.86l-7.19-5.59c-2.01 1.35-4.59 2.15-8.7 2.15-6.87 0-12.73-3.86-15.12-9.09l-7.19 5.59C6.73 42.18 14.82 48 24 48z"/></svg>
      Sign in with Google
    </a>
    <a href="/api/auth/microsoft/login" class="oauth-btn oauth-optional" data-provider="microsoft" style="background:#f3f3f3;color:#2F2F2F;border:1px solid #e5e5e5;display:none">
      <svg width="18" height="18" viewBox="0 0 24 24"><rect fill="#F25022" x="1" y="1" width="10" height="10"/><rect fill="#7FBA00" x="13" y="1" width="10" height="10"/><rect fill="#00A4EF" x="1" y="13" width="10" height="10"/><rect fill="#FFB900" x="13" y="13" width="10" height="10"/></svg>
      Sign in with Microsoft
    </a>
  </div>
</div>

<!-- ── APPROVAL QUEUE TAB ─────────────────────────────── -->
<div class="main" id="tab-queue" style="display:none">
  <div class="tbl-header">
    <h2>Approval Queue</h2>
    <div class="tbl-actions">
      <select class="filter-select" id="status-filter" onchange="currentPage=0;loadApprovals()">
        <option value="pending">Pending</option>
        <option value="approved">Approved</option>
        <option value="rejected">Rejected</option>
        <option value="dispatched">Dispatched</option>
        <option value="dispatch_failed">Dispatch Failed</option>
        <option value="expired">Expired</option>
        <option value="">All</option>
      </select>
    </div>
  </div>
  <div class="tbl-wrap">
    <table>
      <thead>
        <tr>
          <th onclick="sortBy('action_intent')">Intent</th>
          <th onclick="sortBy('approval_status')">Status</th>
          <th onclick="sortBy('chain')">Chain</th>
          <th onclick="sortBy('operator_id')">Operator</th>
          <th onclick="sortBy('created_at')">Age</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="approvals-body">
        <tr class="loading-row"><td colspan="6">Loading…</td></tr>
      </tbody>
    </table>
  </div>
  <div id="approvals-empty" class="empty" style="display:none">No approvals match this filter</div>
  <div class="pagination">
    <span id="page-info" class="mono dim"></span>
    <div class="pagination-btns">
      <button class="pag-btn" id="prev-btn" onclick="prevPage()" disabled>← prev</button>
      <button class="pag-btn" id="next-btn" onclick="nextPage()">next →</button>
    </div>
  </div>
</div>

<!-- ── CHAIN TEMPLATES TAB ──────────────────────────────── -->
<div class="main" id="tab-chains" style="display:none">
  <div class="tbl-header">
    <h2>Chain Templates</h2>
    <button class="btn btn-primary btn-lg" id="btn-new-template" onclick="toggleTemplateForm()">+ New Template</button>
  </div>

  <!-- Create/Edit form -->
  <div class="form-panel" id="template-form">
    <div class="form-title" id="template-form-title">Create Template</div>
    <input type="hidden" id="template-edit-id">
    <div class="form-row">
      <label>Name</label>
      <input type="text" id="tpl-name" placeholder="e.g. Two-Step Legal Review">
    </div>
    <div class="form-row">
      <label>Description (optional)</label>
      <input type="text" id="tpl-desc" placeholder="Brief description">
    </div>
    <div class="form-row">
      <label>Steps</label>
      <div id="tpl-steps-list"></div>
      <button class="btn btn-secondary" style="margin-top:6px;font-size:11px" onclick="addStep()">+ Add Step</button>
    </div>
    <div class="form-btns">
      <button class="btn btn-primary" onclick="submitTemplate()">Save</button>
      <button class="btn btn-secondary" onclick="hideTemplateForm()">Cancel</button>
    </div>
  </div>

  <div id="templates-loading" class="empty" style="display:none">Loading templates…</div>
  <div class="template-grid" id="templates-grid"></div>
  <div id="templates-empty" class="empty" style="display:none">No templates yet — create one above</div>
</div>

<!-- ── DASHBOARD TAB ────────────────────────────────────── -->
<div class="main" id="tab-dashboard" style="display:none">
  <div class="tbl-header">
    <h2>Operational Dashboard</h2>
    <span class="mono dim" id="dash-ts"></span>
  </div>

  <div class="stats-grid" id="stats-grid">
    <div class="stat"><div class="lbl">Pending</div><div class="val pending" id="s-pending">—</div></div>
    <div class="stat"><div class="lbl">Success Rate</div><div class="val success" id="s-rate">—</div></div>
    <div class="stat"><div class="lbl">Retries</div><div class="val neutral" id="s-retries">—</div></div>
    <div class="stat"><div class="lbl">Avg Approval</div><div class="val neutral" id="s-avgtime">—</div></div>
    <div class="stat"><div class="lbl">Created</div><div class="val neutral" id="s-created">—</div></div>
    <div class="stat"><div class="lbl">Approved</div><div class="val success" id="s-approved">—</div></div>
    <div class="stat"><div class="lbl">Rejected</div><div class="val failure" id="s-rejected">—</div></div>
    <div class="stat"><div class="lbl">Expired</div><div class="val neutral" id="s-expired">—</div></div>
    <div class="stat"><div class="lbl">Dispatched</div><div class="val info" id="s-dsuccess">—</div></div>
    <div class="stat"><div class="lbl">Dispatch Failed</div><div class="val failure" id="s-dfailure">—</div></div>
    <div class="stat"><div class="lbl">Dispatch Latency</div><div class="val neutral" id="s-dlat">—</div></div>
    <div class="stat"><div class="lbl">Active Chain Steps</div><div class="val pending" id="s-chainsteps">—</div></div>
  </div>

  <div class="tbl-header"><h2>Recent Dispatches</h2></div>
  <div class="tbl-wrap">
    <table>
      <thead><tr><th>Intent</th><th>Status</th><th>Operator</th><th>Dispatched</th></tr></thead>
      <tbody id="dispatch-body"><tr class="loading-row"><td colspan="4">Loading…</td></tr></tbody>
    </table>
  </div>
  <div id="dispatch-empty" class="empty" style="display:none">No recent dispatches</div>
</div>

<!-- ── PRR TAB ───────────────────────────────────────────── -->
<div class="main" id="tab-prr" style="display:none">
  <div class="tbl-header">
    <h2>Public Records Requests</h2>
    <div class="tbl-actions">
      <select class="filter-select" id="prr-status-filter" onchange="loadPRRQueue()">
        <option value="">All Status</option>
        <option value="submitted">Submitted</option>
        <option value="acknowledged">Acknowledged</option>
        <option value="in_progress">In Progress</option>
        <option value="closed">Closed</option>
      </select>
      <button class="btn btn-primary" id="btn-new-prr" onclick="togglePRRForm()">+ New Request</button>
    </div>
  </div>

  <!-- New PRR form -->
  <div class="form-panel" id="prr-form">
    <div class="form-title">New Public Records Request</div>
    <div class="form-row"><label>Requester Name</label><input type="text" id="prr-name" placeholder="Jane Sullivan"></div>
    <div class="form-row"><label>Description</label><textarea id="prr-desc" placeholder="Describe the records being requested…"></textarea></div>
    <div class="form-row"><label>Due Date</label><input type="date" id="prr-due"></div>
    <div class="form-btns">
      <button class="btn btn-primary" onclick="submitPRRForm()">Create</button>
      <button class="btn btn-secondary" onclick="hidePRRForm()">Cancel</button>
    </div>
  </div>

  <div class="tbl-wrap">
    <table>
      <thead><tr><th>ID</th><th>Requester</th><th>Summary</th><th>Status</th><th>Assigned</th><th>Created</th><th>Actions</th></tr></thead>
      <tbody id="prr-body"><tr class="loading-row"><td colspan="7">Loading…</td></tr></tbody>
    </table>
  </div>
  <div id="prr-empty" class="empty" style="display:none">No public records requests match this filter</div>
</div>

<!-- ── MEMBERS TAB ──────────────────────────────────────── -->
<div class="main" id="tab-members" style="display:none">

  <!-- Usage card -->
  <div class="usage-card">
    <div class="usage-head">
      <div>
        <h3>Workspace Usage</h3>
        <div class="plan-badge plan-free" id="plan-badge">FREE</div>
      </div>
      <button class="btn btn-primary" id="upgrade-btn" onclick="openUpgradeModal()" style="display:none">↑ Upgrade</button>
    </div>
    <div class="usage-metrics" id="usage-metrics">
      <div class="empty mono dim" style="padding:12px 0">Loading usage…</div>
    </div>
  </div>

  <div class="tbl-header">
    <h2>Members</h2>
    <button class="btn btn-primary" id="btn-invite" onclick="toggleInviteForm()">+ Invite</button>
  </div>

  <!-- Invite form -->
  <div class="form-panel" id="invite-form">
    <div class="form-title">Invite Member</div>
    <div class="form-row"><label>Email</label><input type="email" id="invite-email" placeholder="user@example.com"></div>
    <div class="form-row">
      <label>Role</label>
      <select id="invite-role">
        <option value="admin">Admin — manage templates & invites</option>
        <option value="member" selected>Member — create & decide approvals</option>
        <option value="viewer">Viewer — read-only</option>
      </select>
    </div>
    <div class="form-btns">
      <button class="btn btn-primary" onclick="sendInvite()">Send Invitation</button>
      <button class="btn btn-secondary" onclick="hideInviteForm()">Cancel</button>
    </div>
  </div>

  <div class="tbl-wrap">
    <table>
      <thead><tr><th>User ID</th><th>Role</th><th>Joined</th><th>Invited By</th><th>Actions</th></tr></thead>
      <tbody id="members-body"><tr class="loading-row"><td colspan="5">Loading…</td></tr></tbody>
    </table>
  </div>
  <div id="members-empty" class="empty" style="display:none">No members found</div>

  <div class="tbl-header" style="margin-top:28px"><h2>Pending Invitations</h2></div>
  <div class="tbl-wrap">
    <table>
      <thead><tr><th>Email</th><th>Role</th><th>Created</th><th>Expires</th><th>Actions</th></tr></thead>
      <tbody id="invitations-body"><tr class="loading-row"><td colspan="5">Loading…</td></tr></tbody>
    </table>
  </div>
  <div id="invitations-empty" class="empty" style="display:none">No pending invitations</div>
</div>

<!-- ── APPROVAL DETAIL PANEL ────────────────────────────── -->
<div class="overlay" id="detail-overlay" onclick="closeDetail(event)">
  <div class="panel">
    <div class="panel-head">
      <h3 id="detail-title" class="mono">Approval Detail</h3>
      <button class="panel-close" onclick="closeDetailPanel()">✕</button>
    </div>
    <div class="panel-body" id="detail-body">Loading…</div>
  </div>
</div>

<!-- ── PRR DETAIL PANEL ──────────────────────────────────── -->
<div class="overlay" id="prr-detail-overlay" onclick="closePRRDetail(event)">
  <div class="panel">
    <div class="panel-head">
      <h3 class="mono">PRR Detail</h3>
      <button class="panel-close" onclick="closePRRDetailPanel()">✕</button>
    </div>
    <div class="panel-body" id="prr-detail-body">Loading…</div>
  </div>
</div>

<!-- ── UPGRADE MODAL ─────────────────────────────────────── -->
<div id="upgrade-modal" onclick="closeUpgradeModal(event)">
  <div class="modal-card" onclick="event.stopPropagation()">
    <div class="modal-head">
      <h3>Upgrade Workspace</h3>
      <button class="panel-close" onclick="closeUpgradeModal()">✕</button>
    </div>
    <div style="margin-bottom:16px">
      Current plan: <span id="current-plan-badge" class="plan-badge plan-free">FREE</span>
    </div>
    <label class="plan-option">
      <input type="radio" name="plan-pick" value="free" checked>
      <div><div class="po-name">Free</div><div class="po-desc">3 templates · 50 approvals/mo · 1 member</div></div>
    </label>
    <label class="plan-option">
      <input type="radio" name="plan-pick" value="pro">
      <div><div class="po-name" style="color:var(--accent)">Pro</div><div class="po-desc">Unlimited templates, approvals, and members</div></div>
    </label>
    <div class="warn-notice">⚠ Manual admin operation — billing not yet implemented.</div>
    <div class="form-btns">
      <button class="btn btn-primary" onclick="submitPlanChange()">Confirm</button>
      <button class="btn btn-secondary" onclick="closeUpgradeModal()">Cancel</button>
    </div>
  </div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<script>
// ── State ─────────────────────────────────────────────────
let currentPage = 0;
const PAGE_SIZE = 20;
let sortField = 'created_at', sortDir = -1;
let approvals = [];
let authenticated = false;
let userRole = null;

const TAB_HASH = {queue:'approvals',chains:'templates',dashboard:'dashboard',prr:'prr',members:'members'};
const HASH_TAB = Object.fromEntries(Object.entries(TAB_HASH).map(([k,v])=>[v,k]));

// ── Helpers ───────────────────────────────────────────────
function getCookie(n){const m=document.cookie.match(new RegExp("(?:^|; )"+n+"=([^;]*)"));return m?decodeURIComponent(m[1]):null}

function authHeaders(){
  const h={"Content-Type":"application/json"};
  // jwt is httpOnly — can't read from JS; browser sends it automatically via credentials:'include'
  // Fall back to localStorage token if present (manual JWT paste on index.html)
  const t=localStorage.getItem("pj_token");
  if(t) h["Authorization"]="Bearer "+t;
  const c=getCookie("csrf_token");
  if(c) h["x-csrf-token"]=c;
  return h;
}

async function api(path,opts={}){
  const {headers:extraHeaders,...rest}=opts;
  const res=await fetch(path,{credentials:'include',headers:{...authHeaders(),...extraHeaders},...rest});
  if(res.status===401||res.status===403){showAuthGate();throw new Error("Unauthorized")}
  return res.json();
}

function esc(s){
  if(!s) return '';
  const d=document.createElement('div');
  d.textContent=String(s);
  return d.innerHTML;
}

function timeAgo(iso){
  if(!iso) return '—';
  const d=new Date(iso), diff=(Date.now()-d.getTime())/1000;
  if(diff<60) return 'just now';
  if(diff<3600) return Math.floor(diff/60)+'m ago';
  if(diff<86400) return Math.floor(diff/3600)+'h ago';
  return Math.floor(diff/86400)+'d ago';
}

function fmtDur(sec){
  if(!sec||sec<=0) return '—';
  if(sec<60) return sec.toFixed(1)+'s';
  if(sec<3600) return (sec/60).toFixed(1)+'m';
  return (sec/3600).toFixed(1)+'h';
}

let toastTimer;
function toast(msg,type=''){
  const el=document.getElementById('toast');
  el.textContent=msg;el.className='toast show '+(type||'');
  clearTimeout(toastTimer);
  toastTimer=setTimeout(()=>el.classList.remove('show'),3000);
}

// ── Auth gate ─────────────────────────────────────────────
function showAuthGate(){
  authenticated=false;
  document.getElementById('auth-gate').style.display='flex';
  document.querySelectorAll('.main,.tabs').forEach(el=>el.style.display='none');
  document.querySelector('.tabs').style.display='none';
}
function hideAuthGate(){
  authenticated=true;
  document.getElementById('auth-gate').style.display='none';
  document.querySelector('.tabs').style.display='flex';
  if(userRole&&userRole!=='admin') document.body.classList.add('role-viewer');
  else document.body.classList.remove('role-viewer');
  const active=document.querySelector('.tab.active')?.dataset.tab||'queue';
  switchTab(active);
}

// ── Tabs ──────────────────────────────────────────────────
function switchTab(tab){
  document.querySelectorAll('.tab').forEach(t=>t.classList.toggle('active',t.dataset.tab===tab));
  document.querySelectorAll('.main').forEach(el=>el.style.display='none');
  const el=document.getElementById('tab-'+tab);
  if(el) el.style.display='block';
  const hash=TAB_HASH[tab]||tab;
  if(window.location.hash!=='#'+hash) history.replaceState(null,'','#'+hash);
  if(tab==='queue') loadApprovals();
  if(tab==='chains') loadTemplates();
  if(tab==='dashboard') loadDashboard();
  if(tab==='prr') loadPRRQueue();
  if(tab==='members'){loadMembers();loadUsage()}
}

// ── Approval Queue ────────────────────────────────────────
async function loadApprovals(){
  const status=document.getElementById('status-filter').value;
  const qs=`?${status?'status='+status+'&':''}limit=${PAGE_SIZE}&offset=${currentPage*PAGE_SIZE}`;
  try{
    const json=await api('/api/approvals'+qs);
    if(!json.success){toast(json.error||'Load failed','error');return}
    hideAuthGate();
    approvals=json.data.approvals;
    renderApprovals();
    renderPagination(json.data.pendingCount,json.data.total);
  }catch(e){if(e.message!=='Unauthorized')toast('Failed to load approvals','error')}
}

function renderApprovals(){
  const tbody=document.getElementById('approvals-body');
  const empty=document.getElementById('approvals-empty');
  if(!approvals.length){
    tbody.innerHTML='';empty.style.display='block';return;
  }
  empty.style.display='none';
  const sorted=[...approvals].sort((a,b)=>{
    let va=a[sortField],vb=b[sortField];
    if(sortField==='chain'){va=a.chainSummary?.completedSteps??-1;vb=b.chainSummary?.completedSteps??-1}
    return va<vb?-sortDir:va>vb?sortDir:0;
  });
  tbody.innerHTML=sorted.map(a=>{
    const ch=a.chainSummary;
    let chainHtml='<span class="mono dim">—</span>';
    if(ch){
      const pct=ch.totalSteps>0?(ch.completedSteps/ch.totalSteps*100):0;
      const par=ch.activeSteps>1?`<span class="parallel-mark" title="${ch.activeSteps} parallel">⊕${ch.activeSteps}</span>`:'';
      chainHtml=`<div class="chain-prog">
        <div class="chain-track"><div class="chain-fill" style="width:${pct}%"></div></div>
        <span class="chain-text">${ch.completedSteps}/${ch.totalSteps}${par}</span>
        ${ch.currentStepLabel?`<span class="dim" style="font-size:10px">${esc(ch.currentStepLabel)}</span>`:''}
      </div>`;
    }
    const acts=[];
    if(a.approval_status==='pending'){
      acts.push(`<button class="btn btn-approve" onclick="decide('${a.id}','approved')">Approve</button>`);
      acts.push(`<button class="btn btn-reject" onclick="decide('${a.id}','rejected')">Reject</button>`);
    }
    if(a.approval_status==='approved'){
      acts.push(`<button class="btn btn-dispatch" onclick="dispatch('${a.id}')">Dispatch</button>`);
    }
    return`<tr onclick="showDetail('${a.id}')">
      <td><span class="mono" style="font-size:11px">${esc(a.action_intent||'—')}</span></td>
      <td><span class="badge ${a.approval_status}">${a.approval_status}</span></td>
      <td>${chainHtml}</td>
      <td class="mono dim" style="font-size:11px">${esc(a.operator_id||'—')}</td>
      <td class="mono dim" style="font-size:11px">${timeAgo(a.created_at)}</td>
      <td class="actions-cell" onclick="event.stopPropagation()">${acts.join('')||'<span class="dim" style="font-size:11px">—</span>'}</td>
    </tr>`;
  }).join('');
}

function renderPagination(pending,total){
  document.getElementById('page-info').textContent=
    `${approvals.length} result${approvals.length!==1?'s':''}${pending!=null?' · '+pending+' pending':''}`;
  document.getElementById('prev-btn').disabled=currentPage===0;
  document.getElementById('next-btn').disabled=approvals.length<PAGE_SIZE;
}

function prevPage(){if(currentPage>0){currentPage--;loadApprovals()}}
function nextPage(){currentPage++;loadApprovals()}
function sortBy(f){
  if(sortField===f)sortDir*=-1;
  else{sortField=f;sortDir=f==='created_at'?-1:1}
  renderApprovals();
}

// ── Decide / Dispatch ─────────────────────────────────────
async function decide(id,status){
  try{
    const json=await api(`/api/approvals/${id}/decide`,{method:'POST',body:JSON.stringify({status})});
    if(!json.success){toast(json.error||'Decision failed','error');return}
    toast('Approval '+status,'success');loadApprovals();
  }catch(e){if(e.message!=='Unauthorized')toast('Decision failed','error')}
}
async function dispatch(id){
  try{
    const json=await api(`/api/approvals/${id}/dispatch`,{method:'POST',body:JSON.stringify({})});
    if(!json.success){toast(json.error||'Dispatch failed','error');return}
    toast('Dispatched','success');loadApprovals();
  }catch(e){if(e.message!=='Unauthorized')toast('Dispatch failed','error')}
}

// ── Detail panel ──────────────────────────────────────────
async function showDetail(id){
  document.getElementById('detail-overlay').classList.add('open');
  document.getElementById('detail-body').innerHTML='<div class="empty">Loading…</div>';
  try{
    const [ar,cr]=await Promise.all([
      api(`/api/approvals/${id}`),
      api(`/api/approvals/${id}/chain`).catch(()=>null),
    ]);
    if(!ar.success){document.getElementById('detail-body').innerHTML='<div class="empty">Failed to load</div>';return}
    const a=ar.data,ch=cr?.data;
    let html=`<div class="detail-section">
      <h4>Overview</h4>
      <div class="detail-row"><span class="dk">ID</span><span class="dv mono">${esc(a.id?.slice(0,16))}…</span></div>
      <div class="detail-row"><span class="dk">Status</span><span class="dv"><span class="badge ${a.approval_status}">${a.approval_status}</span></span></div>
      <div class="detail-row"><span class="dk">Intent</span><span class="dv mono">${esc(a.action_intent||'—')}</span></div>
      <div class="detail-row"><span class="dk">Mode</span><span class="dv mono">${esc(a.action_mode||'—')}</span></div>
      <div class="detail-row"><span class="dk">Operator</span><span class="dv mono">${esc(a.operator_id||'—')}</span></div>
      <div class="detail-row"><span class="dk">Created</span><span class="dv">${new Date(a.created_at).toLocaleString()}</span></div>
      <div class="detail-row"><span class="dk">Expires</span><span class="dv">${new Date(a.expires_at).toLocaleString()}</span></div>
      ${a.approver_id?`<div class="detail-row"><span class="dk">Approver</span><span class="dv mono">${esc(a.approver_id)}</span></div>`:''}
      ${a.approval_note?`<div class="detail-row"><span class="dk">Note</span><span class="dv">${esc(a.approval_note)}</span></div>`:''}
    </div>`;
    if(ch){
      const byOrder={};
      ch.steps.forEach(s=>{if(!byOrder[s.order])byOrder[s.order]=[];byOrder[s.order].push(s)});
      const pct=ch.totalSteps>0?(ch.completedSteps/ch.totalSteps*100):0;
      html+=`<div class="detail-section">
        <h4>Chain — ${esc(ch.templateName)}</h4>
        <div class="chain-prog" style="margin-bottom:12px">
          <div class="chain-track" style="flex:1;max-width:100%;height:5px"><div class="chain-fill" style="width:${pct}%"></div></div>
          <span class="chain-text">${ch.completedSteps}/${ch.totalSteps} complete</span>
        </div>
        <ul class="chain-steps-list">
          ${ch.steps.map(s=>{
            const sib=(byOrder[s.order]||[]).length>1;
            return`<li class="chain-step-item">
              <div class="step-dot ${s.status}"></div>
              <span>${esc(s.label)}${sib?'<span class="parallel-mark">⊕</span>':''}</span>
              <span class="badge ${s.status}" style="font-size:9px">${s.status}</span>
              ${s.deciderId?`<span class="step-decider">${esc(s.deciderId)}</span>`:''}
            </li>`;
          }).join('')}
        </ul>
      </div>`;
    }
    if(a.plan?.length){
      html+=`<div class="detail-section">
        <h4>Plan (${a.plan.length} steps)</h4>
        <div class="code-block">${esc(JSON.stringify(a.plan,null,2))}</div>
      </div>`;
    }
    if(a.dispatchResult){
      html+=`<div class="detail-section">
        <h4>Dispatch Result</h4>
        <div class="code-block">${esc(JSON.stringify(a.dispatchResult,null,2))}</div>
      </div>`;
    }
    if(a.approval_status==='pending'){
      html+=`<div style="display:flex;gap:8px;margin-top:16px">
        <button class="btn btn-approve btn-lg" onclick="decide('${a.id}','approved');closeDetailPanel()">Approve</button>
        <button class="btn btn-reject btn-lg" onclick="decide('${a.id}','rejected');closeDetailPanel()">Reject</button>
      </div>`;
    }
    if(a.approval_status==='approved'){
      html+=`<div style="margin-top:16px"><button class="btn btn-dispatch btn-lg" onclick="dispatch('${a.id}');closeDetailPanel()">Dispatch</button></div>`;
    }
    document.getElementById('detail-body').innerHTML=html;
  }catch(e){
    if(e.message!=='Unauthorized') document.getElementById('detail-body').innerHTML='<div class="empty">Failed to load details</div>';
  }
}
function closeDetail(e){if(e?.target===document.getElementById('detail-overlay')) closeDetailPanel()}
function closeDetailPanel(){document.getElementById('detail-overlay').classList.remove('open')}

// ── Chain Templates ───────────────────────────────────────
async function loadTemplates(){
  document.getElementById('templates-loading').style.display='block';
  document.getElementById('templates-grid').innerHTML='';
  document.getElementById('templates-empty').style.display='none';
  try{
    const json=await api('/api/chain-templates');
    document.getElementById('templates-loading').style.display='none';
    if(!json.success){toast(json.error||'Load failed','error');return}
    renderTemplates(json.data);
  }catch(e){
    document.getElementById('templates-loading').style.display='none';
    if(e.message!=='Unauthorized') toast('Failed to load templates','error');
  }
}

function renderTemplates(templates){
  const grid=document.getElementById('templates-grid');
  const empty=document.getElementById('templates-empty');
  if(!templates?.length){grid.innerHTML='';empty.style.display='block';return}
  empty.style.display='none';
  grid.innerHTML=templates.map(t=>{
    const steps=t.steps||[];
    const byOrder={};
    steps.forEach(s=>{if(!byOrder[s.order])byOrder[s.order]=[];byOrder[s.order].push(s)});
    const orders=Object.keys(byOrder).sort((a,b)=>Number(a)-Number(b));
    let viz='';
    orders.forEach((ord,i)=>{
      const grp=byOrder[ord];
      if(i>0) viz+=`<span class="step-arr">→</span>`;
      if(grp.length>1){
        viz+=`<div class="par-group"><span class="par-label">⊕ parallel</span>${grp.map(s=>`<span class="step-pill parallel">${esc(s.label)}</span>`).join('')}</div>`;
      }else{
        viz+=`<span class="step-pill">${esc(grp[0].label)}</span>`;
      }
    });
    const isDefault=t.id==='default';
    return`<div class="template-card">
      ${isDefault?'<div class="tc-default-badge">default</div>':''}
      <div class="tc-name">${esc(t.name)}</div>
      <div class="tc-id">${esc(t.id)}</div>
      <div class="tc-meta">${steps.length} step${steps.length!==1?'s':''} · ${orders.length} stage${orders.length!==1?'s':''}</div>
      <div class="tc-viz">${viz||'<span class="dim" style="font-size:11px">No steps defined</span>'}</div>
      <div class="tc-footer">
        <button class="btn btn-secondary" onclick="showTemplateDtl('${esc(t.id)}')">View JSON</button>
        ${!isDefault?`<button class="btn btn-secondary" onclick="editTemplate('${esc(t.id)}')">Edit</button>`:''}
        ${!isDefault?`<button class="btn btn-danger" onclick="deleteTpl('${esc(t.id)}')">Delete</button>`:''}
      </div>
    </div>`;
  }).join('');
}

let stepCounter=0;
function addStep(){
  const list=document.getElementById('tpl-steps-list');
  const idx=stepCounter++;
  const num=list.children.length+1;
  const div=document.createElement('div');
  div.id=`step-${idx}`;div.className='step-row';
  div.innerHTML=`<span class="step-num">Step ${num}</span>
    <input type="text" class="s-role" placeholder="Role (e.g. admin)" style="flex:1">
    <input type="text" class="s-label" placeholder="Label (e.g. Legal Review)" style="flex:2">
    <button class="btn btn-danger" style="padding:3px 8px;font-size:11px" onclick="removeStep('step-${idx}')">✕</button>`;
  list.appendChild(div);
}
function removeStep(id){
  document.getElementById(id)?.remove();
  Array.from(document.getElementById('tpl-steps-list').children).forEach((r,i)=>{
    const sp=r.querySelector('.step-num');if(sp)sp.textContent=`Step ${i+1}`;
  });
}

function toggleTemplateForm(){
  const f=document.getElementById('template-form');
  f.classList.contains('show')?hideTemplateForm():openNewTemplateForm();
}
function openNewTemplateForm(){
  document.getElementById('template-form-title').textContent='Create Template';
  document.getElementById('template-edit-id').value='';
  document.getElementById('tpl-name').value='';
  document.getElementById('tpl-desc').value='';
  stepCounter=0;
  document.getElementById('tpl-steps-list').innerHTML='';
  addStep();
  document.getElementById('template-form').classList.add('show');
}
function hideTemplateForm(){document.getElementById('template-form').classList.remove('show')}

async function submitTemplate(){
  const editId=document.getElementById('template-edit-id').value;
  const name=document.getElementById('tpl-name').value.trim();
  const desc=document.getElementById('tpl-desc').value.trim();
  if(!name){toast('Name required','error');return}
  const rows=document.getElementById('tpl-steps-list').children;
  if(!rows.length){toast('Add at least one step','error');return}
  const steps=[];
  for(let i=0;i<rows.length;i++){
    const role=rows[i].querySelector('.s-role').value.trim();
    const label=rows[i].querySelector('.s-label').value.trim();
    if(!role||!label){toast(`Step ${i+1}: role and label required`,'error');return}
    steps.push({order:i,requiredRole:role,label});
  }
  try{
    const json=editId
      ?await api(`/api/chain-templates/${encodeURIComponent(editId)}`,{method:'PUT',body:JSON.stringify({name,description:desc,steps})})
      :await api('/api/chain-templates',{method:'POST',body:JSON.stringify({name,description:desc,steps})});
    if(!json.success){toast(json.error||'Save failed','error');return}
    toast(editId?'Template updated':'Template created','success');
    hideTemplateForm();loadTemplates();
  }catch(e){if(e.message!=='Unauthorized')toast('Save failed','error')}
}

async function editTemplate(id){
  try{
    const json=await api(`/api/chain-templates/${encodeURIComponent(id)}`);
    if(!json.success){toast('Failed to load template','error');return}
    const t=json.data;
    document.getElementById('template-form-title').textContent='Edit Template';
    document.getElementById('template-edit-id').value=t.id;
    document.getElementById('tpl-name').value=t.name;
    document.getElementById('tpl-desc').value=t.description||'';
    stepCounter=0;
    document.getElementById('tpl-steps-list').innerHTML='';
    (t.steps||[]).forEach(s=>{
      addStep();
      const rows=document.getElementById('tpl-steps-list').children;
      const last=rows[rows.length-1];
      last.querySelector('.s-role').value=s.requiredRole||'';
      last.querySelector('.s-label').value=s.label||'';
    });
    document.getElementById('template-form').classList.add('show');
    document.getElementById('template-form').scrollIntoView({behavior:'smooth'});
  }catch(e){if(e.message!=='Unauthorized')toast('Failed to load template','error')}
}

async function deleteTpl(id){
  if(!confirm(`Delete template "${id}"?`)) return;
  try{
    const json=await api(`/api/chain-templates/${encodeURIComponent(id)}`,{method:'DELETE'});
    if(!json.success){toast(json.error||'Delete failed','error');return}
    toast('Template deleted','success');loadTemplates();
  }catch(e){if(e.message!=='Unauthorized')toast('Delete failed','error')}
}

async function showTemplateDtl(id){
  document.getElementById('detail-title').textContent='Template';
  document.getElementById('detail-overlay').classList.add('open');
  document.getElementById('detail-body').innerHTML='<div class="empty">Loading…</div>';
  try{
    const json=await api(`/api/chain-templates/${encodeURIComponent(id)}`);
    if(!json.success){document.getElementById('detail-body').innerHTML='<div class="empty">Failed to load</div>';return}
    const t=json.data;
    document.getElementById('detail-body').innerHTML=`
      <div class="detail-section">
        <h4>Template</h4>
        <div class="detail-row"><span class="dk">ID</span><span class="dv mono">${esc(t.id)}</span></div>
        <div class="detail-row"><span class="dk">Name</span><span class="dv">${esc(t.name)}</span></div>
        <div class="detail-row"><span class="dk">Steps</span><span class="dv mono">${(t.steps||[]).length}</span></div>
      </div>
      <div class="detail-section">
        <h4>Definition</h4>
        <div class="code-block">${esc(JSON.stringify(t,null,2))}</div>
      </div>`;
  }catch(e){if(e.message!=='Unauthorized')document.getElementById('detail-body').innerHTML='<div class="empty">Failed to load</div>'}
}

// ── Dashboard ─────────────────────────────────────────────
async function loadDashboard(){
  document.getElementById('dash-ts').textContent='';
  try{
    const json=await api('/api/admin/stats');
    if(!json.success) return;
    const d=json.data;
    document.getElementById('s-pending').textContent=d.pending;
    const tot=d.dispatchSuccess+d.dispatchFailure;
    document.getElementById('s-rate').textContent=tot>0?((d.dispatchSuccess/tot)*100).toFixed(1)+'%':'—';
    document.getElementById('s-retries').textContent=d.dispatchRetry;
    document.getElementById('s-avgtime').textContent=fmtDur(d.avgApprovalTimeSec);
    document.getElementById('s-created').textContent=d.approvalsCreated;
    document.getElementById('s-approved').textContent=d.approvalsApproved;
    document.getElementById('s-rejected').textContent=d.approvalsRejected;
    document.getElementById('s-expired').textContent=d.approvalsExpired;
    document.getElementById('s-dsuccess').textContent=d.dispatchSuccess;
    document.getElementById('s-dfailure').textContent=d.dispatchFailure;
    document.getElementById('s-dlat').textContent=fmtDur(d.avgDispatchLatencySec);
    document.getElementById('s-chainsteps').textContent=d.activeChainSteps;
    document.getElementById('dash-ts').textContent='Updated '+new Date().toLocaleTimeString();
  }catch(e){if(e.message!=='Unauthorized')toast('Failed to load stats','error')}
  // Recent dispatches
  try{
    const json=await api('/api/approvals?status=dispatched&limit=20');
    if(!json.success) return;
    const dispatches=json.data.approvals;
    const tbody=document.getElementById('dispatch-body');
    const empty=document.getElementById('dispatch-empty');
    if(!dispatches.length){tbody.innerHTML='';empty.style.display='block';return}
    empty.style.display='none';
    tbody.innerHTML=dispatches.map(a=>`<tr>
      <td class="mono" style="font-size:11px">${esc(a.action_intent||'—')}</td>
      <td><span class="badge dispatched">dispatched</span></td>
      <td class="mono dim" style="font-size:11px">${esc(a.operator_id||'—')}</td>
      <td class="mono dim" style="font-size:11px">${timeAgo(a.dispatched_at||a.updated_at)}</td>
    </tr>`).join('');
  }catch(e){}
}

// ── PRR ───────────────────────────────────────────────────
function togglePRRForm(){
  const f=document.getElementById('prr-form');
  if(f.classList.contains('show')){hidePRRForm();return}
  document.getElementById('prr-name').value='';
  document.getElementById('prr-desc').value='';
  document.getElementById('prr-due').value='';
  f.classList.add('show');
}
function hidePRRForm(){document.getElementById('prr-form').classList.remove('show')}

async function submitPRRForm(){
  const name=document.getElementById('prr-name').value.trim();
  const desc=document.getElementById('prr-desc').value.trim();
  if(!name){toast('Requester name required','error');return}
  if(!desc){toast('Description required','error');return}
  try{
    const body={requesterName:name,description:desc};
    const due=document.getElementById('prr-due').value;
    if(due) body.dueDate=due;
    const json=await api('/api/prr',{method:'POST',body:JSON.stringify(body)});
    if(!json.success){toast(json.error||'Failed to create','error');return}
    toast('Request created','success');hidePRRForm();loadPRRQueue();
  }catch(e){if(e.message!=='Unauthorized')toast('Failed to create','error')}
}

async function loadPRRQueue(){
  const status=document.getElementById('prr-status-filter')?.value||'';
  const params=new URLSearchParams();if(status)params.append('status',status);
  try{
    const json=await api(`/api/prr?${params}`);
    if(json.success) renderPRRQueue(json.data.requests);
  }catch(e){if(e.message!=='Unauthorized')toast('Failed to load PRRs','error')}
}

function renderPRRQueue(reqs){
  const tbody=document.getElementById('prr-body');
  const empty=document.getElementById('prr-empty');
  if(!reqs?.length){tbody.innerHTML='';empty.style.display='block';return}
  empty.style.display='none';
  tbody.innerHTML=reqs.map(p=>`<tr>
    <td class="mono" style="font-size:10px">${esc(p.id?.substring(0,8))}</td>
    <td><div style="font-size:12px">${esc(p.submitter_name||'Anon')}</div><div class="mono dim" style="font-size:10px">${esc(p.submitter_email||'')}</div></td>
    <td style="max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(p.summary)}</td>
    <td><span class="badge prr-${p.status?.replace('_','-')}">${esc((p.status||'').replace('_',' '))}</span></td>
    <td class="mono dim" style="font-size:11px">${esc(p.assigned_to||'—')}</td>
    <td class="mono dim" style="font-size:11px">${timeAgo(p.created_at)}</td>
    <td><button class="btn-link" onclick="openPRRDetail('${p.id}')">View</button></td>
  </tr>`).join('');
}

async function openPRRDetail(id){
  document.getElementById('prr-detail-overlay').classList.add('open');
  document.getElementById('prr-detail-body').innerHTML='<div class="empty">Loading…</div>';
  try{
    const json=await api(`/api/prr/${encodeURIComponent(id)}`);
    if(json.success) renderPRRDetail(json.data);
  }catch(e){if(e.message!=='Unauthorized')document.getElementById('prr-detail-body').innerHTML='<div class="empty">Failed to load</div>'}
}

function renderPRRDetail(prr){
  const comments=prr.comments||[];
  document.getElementById('prr-detail-body').innerHTML=`
    <div class="detail-section">
      <h4>Status</h4>
      <select class="detail-select" onchange="updatePRRStatus('${prr.id}',this.value)">
        ${['submitted','acknowledged','in_progress','closed'].map(s=>`<option value="${s}"${prr.status===s?' selected':''}>${s.replace('_',' ')}</option>`).join('')}
      </select>
    </div>
    <div class="detail-section">
      <h4>Details</h4>
      <div class="detail-row"><span class="dk">Submitter</span><span class="dv">${esc(prr.submitter_name||'Anonymous')}</span></div>
      <div class="detail-row"><span class="dk">Email</span><span class="dv mono">${esc(prr.submitter_email||'—')}</span></div>
      <div class="detail-row"><span class="dk">Summary</span><span class="dv">${esc(prr.summary)}</span></div>
      <div class="detail-row"><span class="dk">Created</span><span class="dv">${timeAgo(prr.created_at)}</span></div>
    </div>
    ${prr.details?`<div class="detail-section"><h4>Description</h4><div style="font-size:12px;color:var(--text-dim);line-height:1.6">${esc(prr.details)}</div></div>`:''}
    <div class="detail-section">
      <h4>Comments (${comments.length})</h4>
      <div id="prr-comments">
        ${comments.map(c=>`<div style="margin-bottom:10px;padding:10px;background:var(--bg-3);border:1px solid var(--border);border-radius:var(--radius)">
          <div class="mono dim" style="font-size:10px;margin-bottom:5px">${timeAgo(c.created_at)} · ${c.user_id?'Admin':'System'}</div>
          <div style="font-size:12px">${esc(c.body)}</div>
        </div>`).join('')||'<div class="dim" style="font-size:12px;padding-bottom:8px">No comments yet</div>'}
      </div>
      <textarea id="prr-comment-input" placeholder="Add a comment…" style="width:100%;padding:8px 10px;margin-top:8px;background:var(--bg-3);border:1px solid var(--border);color:var(--text);border-radius:var(--radius);font-family:var(--font);font-size:12px;min-height:70px;resize:vertical"></textarea>
      <button class="btn btn-primary" style="margin-top:6px" onclick="addPRRComment('${prr.id}')">Add Comment</button>
    </div>`;
}

async function updatePRRStatus(id,status){
  try{
    const json=await api(`/api/prr/${encodeURIComponent(id)}`,{method:'PATCH',body:JSON.stringify({status})});
    if(json.success){toast('Status updated','success');loadPRRQueue()}
  }catch(e){if(e.message!=='Unauthorized')toast('Failed to update','error')}
}

async function addPRRComment(id){
  const inp=document.getElementById('prr-comment-input');
  const body=inp.value.trim();if(!body) return;
  try{
    const json=await api(`/api/prr/${encodeURIComponent(id)}/comment`,{method:'POST',body:JSON.stringify({body})});
    if(json.success){toast('Comment added','success');inp.value='';openPRRDetail(id)}
  }catch(e){if(e.message!=='Unauthorized')toast('Failed to add comment','error')}
}

function closePRRDetail(e){if(!e||e.target===document.getElementById('prr-detail-overlay'))closePRRDetailPanel()}
function closePRRDetailPanel(){document.getElementById('prr-detail-overlay').classList.remove('open')}

// ── Members ───────────────────────────────────────────────
async function loadMembers(){
  try{
    const [mr,ir]=await Promise.all([api('/api/workspace/members'),api('/api/workspace/invitations')]);
    if(mr.success) renderMembers(mr.data);
    if(ir.success) renderInvitations(ir.data);
  }catch(e){if(e.message!=='Unauthorized')toast('Failed to load members','error')}
}

function renderMembers(members){
  const tbody=document.getElementById('members-body');
  const empty=document.getElementById('members-empty');
  if(!members?.length){tbody.innerHTML='';empty.style.display='block';return}
  empty.style.display='none';
  tbody.innerHTML=members.map(m=>`<tr>
    <td class="mono" style="font-size:11px">${esc(m.user_id)}</td>
    <td><span class="badge ${m.role}">${m.role}</span></td>
    <td class="mono dim" style="font-size:11px">${timeAgo(m.joined_at)}</td>
    <td class="mono dim" style="font-size:11px">${esc(m.invited_by||'—')}</td>
    <td>${m.role!=='owner'?`<button class="btn btn-danger" onclick="removeMember('${m.user_id}')">Remove</button>`:''}</td>
  </tr>`).join('');
}

function renderInvitations(invs){
  const tbody=document.getElementById('invitations-body');
  const empty=document.getElementById('invitations-empty');
  if(!invs?.length){tbody.innerHTML='';empty.style.display='block';return}
  empty.style.display='none';
  tbody.innerHTML=invs.map(inv=>`<tr>
    <td class="mono" style="font-size:11px">${esc(inv.email)}</td>
    <td><span class="badge ${inv.role}">${inv.role}</span></td>
    <td class="mono dim" style="font-size:11px">${timeAgo(inv.created_at)}</td>
    <td class="mono dim" style="font-size:11px">${new Date(inv.expires_at).toLocaleDateString()}</td>
    <td class="actions-cell">
      <button class="btn btn-secondary" onclick="copyLink('${inv.token}')">Copy Link</button>
      <button class="btn btn-danger" onclick="revokeInvite('${inv.id}')">Revoke</button>
    </td>
  </tr>`).join('');
}

function toggleInviteForm(){
  const f=document.getElementById('invite-form');
  if(f.classList.contains('show')){hideInviteForm();return}
  document.getElementById('invite-email').value='';
  document.getElementById('invite-role').value='member';
  f.classList.add('show');
}
function hideInviteForm(){document.getElementById('invite-form').classList.remove('show')}

async function sendInvite(){
  const email=document.getElementById('invite-email').value.trim();
  const role=document.getElementById('invite-role').value;
  if(!email){toast('Email required','error');return}
  try{
    const json=await api('/api/workspace/invite',{method:'POST',body:JSON.stringify({email,role})});
    if(!json.success){toast(json.error||'Failed to send','error');return}
    toast(`Invited ${email}`,'success');hideInviteForm();loadMembers();
  }catch(e){if(e.message!=='Unauthorized')toast('Failed to send invite','error')}
}

async function removeMember(uid){
  if(!confirm(`Remove ${uid}?`)) return;
  try{
    const json=await api(`/api/workspace/members/${encodeURIComponent(uid)}`,{method:'DELETE'});
    if(!json.success){toast(json.error||'Failed','error');return}
    toast('Member removed','success');loadMembers();
  }catch(e){if(e.message!=='Unauthorized')toast('Failed','error')}
}

async function revokeInvite(id){
  if(!confirm('Revoke invitation?')) return;
  try{
    const json=await api(`/api/workspace/invitations/${encodeURIComponent(id)}`,{method:'DELETE'});
    if(!json.success){toast(json.error||'Failed','error');return}
    toast('Invitation revoked','success');loadMembers();
  }catch(e){if(e.message!=='Unauthorized')toast('Failed','error')}
}

function copyLink(token){
  navigator.clipboard.writeText(`${location.origin}/pj/invite/${token}`)
    .then(()=>toast('Link copied','success'))
    .catch(()=>toast('Copy failed','error'));
}

// ── Usage & Upgrade ───────────────────────────────────────
async function loadUsage(){
  try{
    const json=await api('/api/workspace/usage');
    if(json.success) renderUsage(json.data);
  }catch(e){}
}

function renderUsage(usage){
  const badge=document.getElementById('plan-badge');
  badge.textContent=usage.plan.toUpperCase();
  badge.className=`plan-badge plan-${usage.plan}`;
  document.getElementById('upgrade-btn').style.display=usage.plan==='free'?'block':'none';
  const metrics=document.getElementById('usage-metrics');
  metrics.innerHTML=['templates','approvals','members'].map(k=>{
    const cur=usage.usage[k],lim=usage.limits[k];
    const pct=lim>0?Math.min((cur/lim)*100,100):0;
    const atLim=cur>=lim,nearLim=pct>=85;
    const barCls=atLim?'at-limit':nearLim?'near':'';
    const chip=atLim?`<span class="limit-chip err">LIMIT</span>`:nearLim?`<span class="limit-chip warn">NEAR</span>`:'';
    return`<div class="usage-item">
      <div class="usage-lbl"><strong>${k.charAt(0).toUpperCase()+k.slice(1)}</strong><div>${chip}<span class="usage-count-text">${cur} / ${lim>=999999?'∞':lim}</span></div></div>
      <div class="usage-track"><div class="usage-bar ${barCls}" style="width:${pct}%"></div></div>
    </div>`;
  }).join('');
}

function openUpgradeModal(){
  const b=document.getElementById('plan-badge');
  const cb=document.getElementById('current-plan-badge');
  cb.textContent=b.textContent;cb.className=b.className;
  document.getElementById('upgrade-modal').classList.add('open');
}
function closeUpgradeModal(e){if(!e||e.target===document.getElementById('upgrade-modal'))document.getElementById('upgrade-modal').classList.remove('open')}

async function submitPlanChange(){
  const plan=document.querySelector('input[name="plan-pick"]:checked')?.value;
  try{
    const me=await fetch('/api/me',{credentials:'include',headers:authHeaders()});
    if(!me.ok){toast('Failed to get workspace','error');return}
    const meData=await me.json();
    const json=await api(`/api/admin/workspace/${encodeURIComponent(meData.workspaceId)}/plan`,{method:'PATCH',body:JSON.stringify({plan})});
    if(!json.success){toast(json.error||'Failed','error');return}
    toast(`Plan updated to ${plan.toUpperCase()}`,'success');
    closeUpgradeModal();loadUsage();
  }catch(e){if(e.message!=='Unauthorized')toast('Failed to update plan','error')}
}

// ── Auto-refresh ──────────────────────────────────────────
let timers=[];
function startAutoRefresh(){
  stopAutoRefresh();
  document.getElementById('auto-ref').style.display='flex';
  timers.push(setInterval(()=>{if(document.querySelector('.tab.active')?.dataset.tab==='queue')loadApprovals()},30000));
  timers.push(setInterval(()=>{if(document.querySelector('.tab.active')?.dataset.tab==='dashboard')loadDashboard()},60000));
  timers.push(setInterval(()=>{if(document.querySelector('.tab.active')?.dataset.tab==='prr')loadPRRQueue()},30000));
}
function stopAutoRefresh(){
  timers.forEach(clearInterval);timers=[];
  document.getElementById('auto-ref').style.display='none';
}

// ── Refresh button ────────────────────────────────────────
async function refresh(){
  const btn=document.getElementById('refresh-btn');
  btn.disabled=true;btn.textContent='↻…';
  try{
    const tab=document.querySelector('.tab.active')?.dataset.tab;
    if(tab==='queue') await loadApprovals();
    if(tab==='chains') await loadTemplates();
    if(tab==='dashboard') await loadDashboard();
    if(tab==='prr') await loadPRRQueue();
    if(tab==='members'){await loadMembers();await loadUsage()}
  }finally{btn.disabled=false;btn.textContent='↻ Refresh'}
}

// ── Hash navigation ───────────────────────────────────────
window.addEventListener('hashchange',()=>{
  const tab=HASH_TAB[location.hash.replace('#','')];
  if(tab) switchTab(tab);
});

// ── Init ──────────────────────────────────────────────────
(async function init(){
  // /api/me returns 200+data when authenticated, 401 when not.
  // It provides sub, email, name, role, workspaceId, workspaceName in one call.
  let isAuthenticated=false;
  let userEmail='';
  let userName='';
  let wsName='';
  try{
    const res=await fetch('/api/me',{credentials:'include',headers:authHeaders()});
    if(res.ok){
      const me=await res.json();
      isAuthenticated=true;
      userEmail=me.email||'';
      userName=me.name||'';
      userRole=me.role||'viewer';
      wsName=me.workspaceName||'';
    }
  }catch{}

  // Update workspace chip
  if(wsName){
    const chip=document.getElementById('ws-chip');
    chip.textContent=wsName;
    chip.style.display='inline-block';
  }

  // Update auth status banner
  const statusBanner=document.getElementById('auth-status');
  const statusText=document.getElementById('auth-status-text');
  if(isAuthenticated){
    statusBanner.style.background='var(--accent-dim)';
    statusBanner.style.borderColor='rgba(0,229,160,0.3)';
    const displayName=userName||userEmail||'Authenticated User';
    const roleText=userRole==='admin'?' (Admin)':'';
    statusText.innerHTML=`✓ Signed in as <strong>${displayName}</strong>${roleText} — <a href="/api/auth/logout" onclick="return confirm('Sign out?')">Sign out</a>`;
  }else{
    statusBanner.style.background='var(--yellow-dim)';
    statusBanner.style.borderColor='rgba(245,200,66,0.3)';
    statusText.innerHTML='Not signed in — <a href="#" onclick="document.getElementById(\'auth-gate\').scrollIntoView({behavior:\'smooth\'});return false">Sign in</a> to manage approvals';
  }

  if(isAuthenticated){
    authenticated=true;
    document.getElementById('auth-gate').style.display='none';
    document.querySelector('.tabs').style.display='flex';
    if(userRole&&userRole!=='admin') document.body.classList.add('role-viewer');
    const hash=location.hash.replace('#','');
    const tab=HASH_TAB[hash];
    if(tab) switchTab(tab);
    else switchTab('queue');
    startAutoRefresh();
  }else{
    showAuthGate();
  }
})();
</script>
</body>
</html>
