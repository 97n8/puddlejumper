<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PuddleJumper — Control Plane Admin</title>
<link rel="stylesheet" href="/styles/pj-admin.css">
</head>
<body>

<div class="header">
  <div class="header-left">
    <h1>PuddleJumper Admin</h1>
    <span class="subtitle">Control Plane</span>
    <span id="workspace-name" class="subtitle workspace-name hidden"></span>
  </div>
  <div class="header-right">
    <span id="auto-refresh-indicator" class="auto-refresh-text hidden">⟳ Auto-refresh</span>
    <a class="guide-link" href="/pj/guide">Quick Start</a>
    <button class="refresh-btn" data-action="refresh" id="refresh-btn">⟳ Refresh</button>
  </div>
</div>

<div class="tabs">
  <button class="tab active" data-tab="queue" data-action="switchTab">Approval Queue</button>
  <button class="tab" data-tab="chains" data-action="switchTab">Chain Templates</button>
  <button class="tab" data-tab="dashboard" data-action="switchTab">Dashboard</button>
  <button class="tab" data-tab="prr" data-action="switchTab">PRR</button>
  <button class="tab" data-tab="members" data-action="switchTab">Members</button>
</div>

<!-- Auth gate (shown when user isn't authenticated) -->
<div id="auth-gate" class="hidden">
  <h2>Welcome to PuddleJumper</h2>
  <p>Sign in to view governed operations and approval workflows.</p>
  <a href="/api/auth/github/login" class="github-login-btn">
    <svg width="20" height="20" viewBox="0 0 16 16" fill="white"><path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"/></svg>
    Sign in with GitHub
  </a>
</div>

<!-- Viewer banner -->
<div class="viewer-banner">
  <span>Viewing as guest — <a href="/api/auth/github/login">sign up</a> to govern your own operations</span>
</div>

<!-- Approval Queue Tab -->
<div class="main" id="tab-queue">
  <div class="table-header">
    <h2>Approvals</h2>
    <div class="filter-group">
      <select id="status-filter" data-action="loadApprovals">
        <option value="pending">Pending</option>
        <option value="approved">Approved</option>
        <option value="rejected">Rejected</option>
        <option value="dispatched">Dispatched</option>
        <option value="dispatch_failed">Dispatch Failed</option>
        <option value="expired">Expired</option>
        <option value="">All</option>
      </select>
    </div>
  </div>

  <div id="approvals-table-wrap">
    <div id="approvals-loading" class="empty-state hidden">Loading approvals…</div>
    <table>
      <thead>
        <tr>
          <th data-action="sortBy" data-sort="action_intent">Intent</th>
          <th data-action="sortBy" data-sort="approval_status">Status</th>
          <th data-action="sortBy" data-sort="chain">Chain Progress</th>
          <th data-action="sortBy" data-sort="operator_id">Operator</th>
          <th data-action="sortBy" data-sort="created_at">Created</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="approvals-body"></tbody>
    </table>
    <div id="empty-state" class="empty-state hidden">No approvals match the selected filter.</div>
  </div>

  <div class="pagination">
    <span id="page-info"></span>
    <div class="pagination-buttons">
      <button id="prev-btn" data-action="prevPage" disabled>← Previous</button>
      <button id="next-btn" data-action="nextPage">Next →</button>
    </div>
  </div>
</div>

<!-- Chain Templates Tab -->
<div class="main hidden" id="tab-chains">
  <div class="table-header">
    <h2>Chain Templates</h2>
    <button class="btn btn-primary" data-action="toggleCreateTemplateForm">+ Create Template</button>
  </div>
  <div class="section-desc">Define multi-step approval routing with sequential and parallel steps</div>

  <!-- Create / Edit Template Form (hidden by default) -->
  <div id="template-form-wrap" class="form-panel hidden">
    <h3 class="form-panel-title" id="template-form-title">Create Template</h3>
    <input type="hidden" id="template-edit-id" value="">
    <div class="form-group">
      <label class="form-label">Name</label>
      <input type="text" id="template-name" placeholder="e.g. Two-Step Legal Review" class="form-input">
    </div>
    <div class="form-group">
      <label class="form-label">Description (optional)</label>
      <input type="text" id="template-description" placeholder="Brief description" class="form-input">
    </div>
    <div class="form-group">
      <label class="form-label-gap">Steps</label>
      <div id="template-steps-list"></div>
      <button class="btn btn-secondary btn-mt" data-action="addTemplateStep">+ Add Step</button>
    </div>
    <div class="form-actions">
      <button class="btn btn-primary" data-action="submitTemplate">Save Template</button>
      <button class="btn btn-secondary" data-action="cancelTemplateForm">Cancel</button>
    </div>
  </div>

  <div id="templates-loading" class="empty-state hidden">Loading templates…</div>
  <div id="templates-grid" class="template-grid"></div>
  <div id="templates-empty" class="empty-state hidden">No chain templates yet — create one above to define multi-step approval routing.</div>
</div>

<!-- Dashboard Tab -->
<div class="main hidden" id="tab-dashboard">
  <div class="dashboard-section-header">
    <h2 class="dashboard-section-title">Operational Dashboard</h2>
    <span id="dashboard-last-refreshed" class="dashboard-timestamp"></span>
  </div>
  <div id="dashboard-loading" class="empty-state hidden">Loading dashboard…</div>

  <div class="stats-grid" id="stats-grid">
    <div class="stat-card"><div class="label">Pending Approvals</div><div class="value pending" id="s-pending">—</div></div>
    <div class="stat-card"><div class="label">Success Rate</div><div class="value success" id="s-success-rate">—</div></div>
    <div class="stat-card"><div class="label">Dispatch Retries</div><div class="value neutral" id="s-retries">—</div></div>
    <div class="stat-card"><div class="label">Avg Approval Time</div><div class="value neutral" id="s-avg-time">—</div></div>
  </div>

  <div class="stats-grid">
    <div class="stat-card"><div class="label">Approvals Created</div><div class="value neutral" id="s-created">—</div></div>
    <div class="stat-card"><div class="label">Approved</div><div class="value success" id="s-approved">—</div></div>
    <div class="stat-card"><div class="label">Rejected</div><div class="value failure" id="s-rejected">—</div></div>
    <div class="stat-card"><div class="label">Expired</div><div class="value neutral" id="s-expired">—</div></div>
  </div>

  <div class="stats-grid">
    <div class="stat-card"><div class="label">Dispatch Success</div><div class="value success" id="s-d-success">—</div></div>
    <div class="stat-card"><div class="label">Dispatch Failure</div><div class="value failure" id="s-d-failure">—</div></div>
    <div class="stat-card"><div class="label">Avg Dispatch Latency</div><div class="value neutral" id="s-d-latency">—</div></div>
    <div class="stat-card"><div class="label">Active Chain Steps</div><div class="value pending" id="s-chain-steps">—</div></div>
  </div>

  <h2 class="dashboard-subtitle">Recent Dispatches</h2>
  <table>
    <thead>
      <tr>
        <th>Intent</th>
        <th>Status</th>
        <th>Operator</th>
        <th>Dispatched</th>
      </tr>
    </thead>
    <tbody id="dispatch-body"></tbody>
  </table>
  <div id="dispatch-empty" class="empty-state hidden">No recent dispatches yet.</div>
</div>

<!-- Members Tab -->
<div class="main hidden" id="tab-members">
  
  <!-- Usage & Plan Card -->
  <div class="usage-card" id="usage-card">
    <div class="usage-header">
      <div>
        <h3>Workspace Usage</h3>
        <div class="plan-badge" id="plan-badge">FREE</div>
      </div>
      <button class="btn btn-upgrade" id="upgrade-btn" data-action="openUpgradeModal">⬆️ Upgrade</button>
    </div>
    
    <div class="usage-metrics" id="usage-metrics">
      <!-- Populated by renderUsageCard() -->
    </div>
  </div>

  <div class="table-header">
    <h2>Workspace Members</h2>
    <button class="btn btn-primary" data-action="toggleInviteForm">+ Invite Member</button>
  </div>

  <!-- Invite Member Form (hidden by default) -->
  <div id="invite-form-wrap" class="form-panel hidden">
    <h3 class="form-panel-title">Invite Member</h3>
    <div class="form-group">
      <label class="form-label">Email</label>
      <input type="email" id="invite-form-email" placeholder="user@example.com" class="form-input">
    </div>
    <div class="form-group">
      <label class="form-label">Role</label>
      <select id="invite-form-role" class="form-input">
        <option value="admin">Admin</option>
        <option value="viewer">Viewer</option>
      </select>
    </div>
    <div class="form-actions">
      <button class="btn btn-primary" data-action="submitInviteForm">Send Invitation</button>
      <button class="btn btn-secondary" data-action="cancelInviteForm">Cancel</button>
    </div>
  </div>

  <div id="members-table-wrap">
    <table>
      <thead>
        <tr>
          <th>User ID</th>
          <th>Role</th>
          <th>Joined</th>
          <th>Invited By</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="members-body"></tbody>
    </table>
    <div id="members-empty" class="empty-state hidden">No workspace members found. Use the Invite Member button to add team members.</div>
  </div>

  <div class="table-header section-mt">
    <h2>Pending Invitations</h2>
  </div>

  <div id="invitations-table-wrap">
    <table>
      <thead>
        <tr>
          <th>Email</th>
          <th>Role</th>
          <th>Created</th>
          <th>Expires</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="invitations-body"></tbody>
    </table>
    <div id="invitations-empty" class="empty-state hidden">No pending invitations. Send an invite using the button above.</div>
  </div>
</div>

<!-- PRR Tab -->
<div class="main hidden" id="tab-prr">
  <div class="table-header">
    <h2>Public Records Requests</h2>
    <div class="flex-row">
      <div class="filter-group">
        <select id="prr-status-filter" data-action="loadPRRQueue">
          <option value="">All Status</option>
          <option value="submitted">Submitted</option>
          <option value="acknowledged">Acknowledged</option>
          <option value="in_progress">In Progress</option>
          <option value="closed">Closed</option>
        </select>
      </div>
      <button class="btn btn-primary" data-action="togglePRRForm">+ New Request</button>
    </div>
  </div>

  <!-- New PRR Form (hidden by default) -->
  <div id="prr-form-wrap" class="form-panel hidden">
    <h3 class="form-panel-title">New Public Records Request</h3>
    <div class="form-group">
      <label class="form-label">Requester Name</label>
      <input type="text" id="prr-form-name" placeholder="e.g. Jane Sullivan" class="form-input">
    </div>
    <div class="form-group">
      <label class="form-label">Description</label>
      <textarea id="prr-form-description" placeholder="Describe the records being requested…" rows="4" class="form-textarea"></textarea>
    </div>
    <div class="form-group">
      <label class="form-label">Due Date</label>
      <input type="date" id="prr-form-due" class="form-input">
    </div>
    <div class="form-actions">
      <button class="btn btn-primary" data-action="submitPRRForm">Create Request</button>
      <button class="btn btn-secondary" data-action="cancelPRRForm">Cancel</button>
    </div>
  </div>

  <div id="prr-queue-wrap">
    <div id="prr-loading" class="empty-state hidden">Loading PRRs…</div>
    <table>
      <thead>
        <tr>
          <th>ID</th>
          <th>Submitter</th>
          <th>Summary</th>
          <th>Status</th>
          <th>Assigned</th>
          <th>Created</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="prr-queue-body"></tbody>
    </table>
    <div id="prr-queue-empty" class="empty-state hidden">No public records requests match the selected filter.</div>
  </div>
</div>

<!-- PRR Detail Modal -->
<div class="detail-overlay" id="prr-detail-overlay" data-action="closePRRDetail">
  <div class="detail-panel" data-stop-propagation>
    <h3>
      <span id="prr-detail-title">PRR Detail</span>
      <button class="detail-close" data-action="forceClosePRRDetail">✕</button>
    </h3>
    <div class="detail-content" id="prr-detail-content">
      <!-- Populated by renderPRRDetail() -->
    </div>
  </div>
</div>

<!-- Invite Member Modal -->
<div class="detail-overlay" id="invite-modal" data-action="closeInviteModal">
  <div class="detail-panel" data-stop-propagation>
    <h3>
      <span>Invite Member</span>
      <button class="detail-close" data-action="forceCloseInviteModal">✕</button>
    </h3>
    <div class="modal-body">
      <div class="detail-field modal-field">
        <label class="modal-label">Email</label>
        <input type="email" id="invite-email" placeholder="user@example.com" class="form-input">
      </div>
      <div class="detail-field modal-field">
        <label class="modal-label">Role</label>
        <select id="invite-role" class="form-input">
          <option value="member">Member (can create/decide approvals)</option>
          <option value="admin">Admin (can also manage templates & invites)</option>
          <option value="viewer">Viewer (read-only access)</option>
        </select>
      </div>
      <div class="form-actions">
        <button class="btn btn-primary" data-action="sendInvite">Send Invitation</button>
        <button class="btn btn-secondary" data-action="forceCloseInviteModal">Cancel</button>
      </div>
    </div>
  </div>
</div>

<!-- Upgrade Plan Modal -->
<div class="detail-overlay" id="upgrade-modal" data-action="closeUpgradeModal">
  <div class="detail-panel" data-stop-propagation>
    <h3>
      <span>Upgrade Workspace Plan</span>
      <button class="detail-close" data-action="forceCloseUpgradeModal">✕</button>
    </h3>
    <div class="modal-body">
      <div class="plan-current-info">
        <strong>Current Plan:</strong> <span id="current-plan-display" class="plan-badge">FREE</span>
      </div>
      
      <div class="detail-field modal-field">
        <label class="modal-label-gap">Select New Plan</label>
        <div class="plan-options">
          <label class="plan-option">
            <input type="radio" name="plan-choice" value="free" checked>
            <div>
              <div class="plan-option-name">Free</div>
              <div class="plan-option-desc">3 templates, 50 approvals/mo, 1 member</div>
            </div>
          </label>
          <label class="plan-option plan-option-pro">
            <input type="radio" name="plan-choice" value="pro">
            <div>
              <div class="plan-option-name-pro">Pro</div>
              <div class="plan-option-desc">Unlimited templates, approvals, and members</div>
            </div>
          </label>
        </div>
      </div>
      
      <div class="upgrade-warning">
        ⚠️ Note: This is a manual admin operation. Billing is not yet implemented.
      </div>
      
      <div class="form-actions">
        <button class="btn btn-primary" data-action="submitPlanChange">Confirm Upgrade</button>
        <button class="btn btn-secondary" data-action="forceCloseUpgradeModal">Cancel</button>
      </div>
    </div>
  </div>
</div>

<!-- Detail slide-out panel -->
<div class="detail-overlay" id="detail-overlay" data-action="closeDetail">
  <div class="detail-panel" id="detail-panel" data-stop-propagation>
    <h3>
      <span id="detail-title">Approval Detail</span>
      <button class="detail-close" data-action="forceCloseDetail">✕</button>
    </h3>
    <div id="detail-content"></div>
  </div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<script src="/scripts/pj-admin.js"></script>
</body>
</html>
