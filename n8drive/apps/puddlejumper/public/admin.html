<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PuddleJumper — Control Plane Admin</title>
<style>
/* ── Reset + Variables ─────────────────────────────────────────────── */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
:root {
  --bg: #0f1117;
  --surface: #1a1d27;
  --surface-hover: #22252f;
  --border: #2a2d37;
  --text: #e4e6eb;
  --text-dim: #8b8fa3;
  --accent: #4f8ff7;
  --green: #34d399;
  --red: #f87171;
  --yellow: #fbbf24;
  --purple: #a78bfa;
  --radius: 8px;
  --font: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
  --mono: "SF Mono", "Fira Code", "Cascadia Code", monospace;
}
body { font-family: var(--font); background: var(--bg); color: var(--text); min-height: 100vh; }
a { color: var(--accent); text-decoration: none; }
a:hover { text-decoration: underline; }

/* ── Layout ────────────────────────────────────────────────────────── */
.header {
  display: flex; align-items: center; justify-content: space-between;
  padding: 16px 24px; border-bottom: 1px solid var(--border);
  background: var(--surface);
}
.header h1 { font-size: 18px; font-weight: 600; }
.header .subtitle { font-size: 13px; color: var(--text-dim); margin-left: 12px; }
.header-right { display: flex; align-items: center; gap: 10px; }
.header .refresh-btn {
  background: var(--accent); color: #fff; border: none; border-radius: var(--radius);
  padding: 6px 14px; font-size: 13px; cursor: pointer; font-family: var(--font);
}
.header .refresh-btn:hover { opacity: 0.9; }
.header .refresh-btn:disabled { opacity: 0.5; cursor: not-allowed; }
.header .guide-link {
  font-size: 13px; color: var(--text-dim); padding: 6px 12px;
  border: 1px solid var(--border); border-radius: var(--radius);
}
.header .guide-link:hover { color: var(--text); border-color: var(--text-dim); text-decoration: none; }

.tabs {
  display: flex; gap: 0; background: var(--surface); border-bottom: 1px solid var(--border);
  padding: 0 24px; overflow-x: auto;
}
.tab {
  padding: 10px 20px; font-size: 14px; cursor: pointer; border: none;
  background: transparent; color: var(--text-dim); border-bottom: 2px solid transparent;
  font-family: var(--font); transition: color 0.15s, border-color 0.15s; white-space: nowrap;
}
.tab:hover { color: var(--text); }
.tab.active { color: var(--accent); border-bottom-color: var(--accent); }

.main { padding: 24px; max-width: 1200px; }

/* ── Auth gate ─────────────────────────────────────────────────────── */
#auth-gate {
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  min-height: 60vh; gap: 16px;
}
#auth-gate h2 { font-size: 20px; }
#auth-gate p { color: var(--text-dim); font-size: 14px; }

/* ── Stats cards ───────────────────────────────────────────────────── */
.stats-grid {
  display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
  gap: 12px; margin-bottom: 24px;
}
.stat-card {
  background: var(--surface); border: 1px solid var(--border);
  border-radius: var(--radius); padding: 16px;
}
.stat-card .label { font-size: 12px; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.5px; }
.stat-card .value { font-size: 28px; font-weight: 700; margin-top: 4px; font-variant-numeric: tabular-nums; }
.stat-card .value.pending { color: var(--yellow); }
.stat-card .value.success { color: var(--green); }
.stat-card .value.failure { color: var(--red); }
.stat-card .value.neutral { color: var(--text); }

/* ── Table ─────────────────────────────────────────────────────────── */
.table-header {
  display: flex; justify-content: space-between; align-items: center;
  margin-bottom: 12px;
}
.table-header h2 { font-size: 16px; font-weight: 600; }
.filter-group { display: flex; gap: 8px; align-items: center; }
.filter-group select, .filter-group input {
  background: var(--surface); border: 1px solid var(--border); color: var(--text);
  border-radius: var(--radius); padding: 6px 10px; font-size: 13px;
  font-family: var(--font);
}

table { width: 100%; border-collapse: collapse; font-size: 13px; }
thead th {
  text-align: left; padding: 10px 12px; font-weight: 600;
  border-bottom: 1px solid var(--border); color: var(--text-dim);
  font-size: 12px; text-transform: uppercase; letter-spacing: 0.3px;
  cursor: pointer; user-select: none;
}
thead th:hover { color: var(--text); }
tbody td { padding: 10px 12px; border-bottom: 1px solid var(--border); vertical-align: middle; }
tbody tr:hover { background: var(--surface-hover); }

.status-badge {
  display: inline-block; padding: 2px 8px; border-radius: 12px;
  font-size: 11px; font-weight: 600; text-transform: uppercase;
}
.status-badge.pending { background: rgba(251,191,36,0.15); color: var(--yellow); }
.status-badge.approved { background: rgba(52,211,153,0.15); color: var(--green); }
.status-badge.rejected { background: rgba(248,113,113,0.15); color: var(--red); }
.status-badge.dispatched { background: rgba(79,143,247,0.15); color: var(--accent); }
.status-badge.dispatching { background: rgba(79,143,247,0.15); color: var(--accent); }
.status-badge.dispatch_failed { background: rgba(248,113,113,0.15); color: var(--red); }
.status-badge.expired { background: rgba(139,143,163,0.15); color: var(--text-dim); }
.status-badge.active { background: rgba(251,191,36,0.15); color: var(--yellow); }
.status-badge.skipped { background: rgba(139,143,163,0.15); color: var(--text-dim); }

.chain-progress {
  display: flex; align-items: center; gap: 6px; font-size: 12px;
}
.chain-bar {
  display: flex; height: 6px; border-radius: 3px; overflow: hidden;
  flex: 1; max-width: 80px; background: var(--border);
}
.chain-bar-fill { background: var(--green); transition: width 0.3s; }

.actions { display: flex; gap: 6px; }
.btn {
  border: none; border-radius: var(--radius); padding: 5px 12px;
  font-size: 12px; cursor: pointer; font-family: var(--font); font-weight: 500;
}
.btn-approve { background: var(--green); color: #000; }
.btn-reject { background: var(--red); color: #fff; }
.btn-dispatch { background: var(--accent); color: #fff; }
.btn-secondary { background: var(--surface); color: var(--text); border: 1px solid var(--border); }
.btn-danger { background: transparent; color: var(--red); border: 1px solid var(--red); }
.btn:hover { opacity: 0.85; }
.btn:disabled { opacity: 0.4; cursor: not-allowed; }

.empty-state {
  text-align: center; padding: 48px 24px;
  color: var(--text-dim); font-size: 14px;
}

/* ── Detail panel ──────────────────────────────────────────────────── */
.detail-overlay {
  position: fixed; inset: 0; background: rgba(0,0,0,0.5);
  z-index: 100; display: none;
}
.detail-overlay.open { display: flex; justify-content: flex-end; }
.detail-panel {
  width: min(520px, 100%); background: var(--bg);
  border-left: 1px solid var(--border);
  height: 100%; overflow-y: auto; padding: 24px;
}
.detail-panel h3 { font-size: 16px; margin-bottom: 16px; display: flex; justify-content: space-between; align-items: center; }
.detail-close { background: none; border: none; color: var(--text-dim); font-size: 20px; cursor: pointer; }
.detail-close:hover { color: var(--text); }
.detail-section { margin-bottom: 20px; }
.detail-section h4 { font-size: 13px; color: var(--text-dim); margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.3px; }
.detail-field { display: flex; justify-content: space-between; padding: 6px 0; font-size: 13px; }
.detail-field .lbl { color: var(--text-dim); }
.chain-steps-list { list-style: none; }
.chain-steps-list li {
  display: flex; align-items: center; gap: 8px;
  padding: 8px 0; border-bottom: 1px solid var(--border); font-size: 13px;
}
.step-dot {
  width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0;
}
.step-dot.approved { background: var(--green); }
.step-dot.active { background: var(--yellow); }
.step-dot.pending { background: var(--border); }
.step-dot.rejected { background: var(--red); }
.step-dot.skipped { background: var(--text-dim); }

.toast {
  position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%);
  background: var(--surface); border: 1px solid var(--border);
  padding: 10px 20px; border-radius: var(--radius); font-size: 13px;
  z-index: 200; opacity: 0; transition: opacity 0.3s;
}
.toast.show { opacity: 1; }
.toast.success { border-color: var(--green); }
.toast.error { border-color: var(--red); }

/* ── Pagination ────────────────────────────────────────────────────── */
.pagination {
  display: flex; justify-content: space-between; align-items: center;
  margin-top: 12px; font-size: 13px; color: var(--text-dim);
}
.pagination button {
  background: var(--surface); border: 1px solid var(--border); color: var(--text);
  border-radius: var(--radius); padding: 5px 12px; font-size: 12px;
  cursor: pointer; font-family: var(--font);
}
.pagination button:disabled { opacity: 0.4; cursor: not-allowed; }

/* ── Chain template cards ──────────────────────────────────────────── */
.template-grid {
  display: grid; grid-template-columns: repeat(auto-fit, minmax(340px, 1fr));
  gap: 16px; margin-bottom: 24px;
}
.template-card {
  background: var(--surface); border: 1px solid var(--border);
  border-radius: var(--radius); padding: 20px; position: relative;
}
.template-card .template-name { font-size: 15px; font-weight: 600; margin-bottom: 4px; }
.template-card .template-id { font-size: 11px; color: var(--text-dim); font-family: var(--mono); }
.template-card .template-meta { font-size: 12px; color: var(--text-dim); margin-top: 8px; }
.template-steps-viz {
  display: flex; align-items: center; gap: 0; margin-top: 12px; flex-wrap: wrap;
}
.step-group {
  display: flex; flex-direction: column; gap: 4px; align-items: center;
}
.step-pill {
  background: rgba(79,143,247,0.12); color: var(--accent); border: 1px solid rgba(79,143,247,0.25);
  border-radius: 14px; padding: 3px 10px; font-size: 11px; white-space: nowrap;
}
.step-pill.parallel { background: rgba(167,139,250,0.12); color: var(--purple); border-color: rgba(167,139,250,0.25); }
.step-arrow { color: var(--text-dim); font-size: 14px; margin: 0 6px; }
.parallel-bracket {
  font-size: 11px; color: var(--purple); margin-bottom: 2px; font-weight: 600;
}
.template-actions {
  display: flex; gap: 6px; margin-top: 14px; padding-top: 12px;
  border-top: 1px solid var(--border);
}
.template-default { position: absolute; top: 12px; right: 14px; font-size: 10px; color: var(--green); text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600; }

/* ── Responsive ────────────────────────────────────────────────────── */
@media (max-width: 768px) {
  .main { padding: 16px; }
  .stats-grid { grid-template-columns: repeat(2, 1fr); }
  .template-grid { grid-template-columns: 1fr; }
  table { font-size: 12px; }
  thead th, tbody td { padding: 8px 6px; }
}
/* ── Viewer role: hide mutations ───────────────────────────────────── */
body.role-viewer .btn-approve,
body.role-viewer .btn-reject,
body.role-viewer .btn-dispatch,
body.role-viewer .btn-danger,
body.role-viewer .template-actions { display: none !important; }

.viewer-banner {
  background: rgba(79,143,247,0.1); border: 1px solid rgba(79,143,247,0.25);
  color: var(--accent); padding: 10px 24px; font-size: 13px;
  display: none; align-items: center; justify-content: space-between;
}
body.role-viewer .viewer-banner { display: flex; }
.viewer-banner a { color: var(--accent); font-weight: 600; }</style>
</head>
<body>

<div class="header">
  <div style="display:flex;align-items:baseline;">
    <h1>PuddleJumper Admin</h1>
    <span class="subtitle">Control Plane</span>
  </div>
  <div class="header-right">
    <a class="guide-link" href="/pj/guide">Quick Start</a>
    <button class="refresh-btn" onclick="refresh()" id="refresh-btn">⟳ Refresh</button>
  </div>
</div>

<div class="tabs">
  <button class="tab active" data-tab="queue" onclick="switchTab('queue')">Approval Queue</button>
  <button class="tab" data-tab="chains" onclick="switchTab('chains')">Chain Templates</button>
  <button class="tab" data-tab="dashboard" onclick="switchTab('dashboard')">Dashboard</button>
</div>

<!-- Auth gate (shown when user isn't authenticated) -->
<div id="auth-gate" style="display:none;">
  <h2>Welcome to PuddleJumper</h2>
  <p>Sign in to view governed operations and approval workflows.</p>
  <a href="/api/auth/github/login" style="display:inline-flex;align-items:center;gap:8px;background:#24292e;color:#fff;padding:10px 20px;border-radius:var(--radius);font-size:14px;font-weight:500;text-decoration:none;margin-top:8px">
    <svg width="20" height="20" viewBox="0 0 16 16" fill="white"><path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"/></svg>
    Sign in with GitHub
  </a>
</div>

<!-- Viewer banner -->
<div class="viewer-banner">
  <span>Viewing as guest — <a href="/api/auth/github/login">sign up</a> to govern your own operations</span>
</div>

<!-- Approval Queue Tab -->
<div class="main" id="tab-queue">
  <div class="table-header">
    <h2>Approvals</h2>
    <div class="filter-group">
      <select id="status-filter" onchange="loadApprovals()">
        <option value="pending">Pending</option>
        <option value="approved">Approved</option>
        <option value="rejected">Rejected</option>
        <option value="dispatched">Dispatched</option>
        <option value="dispatch_failed">Dispatch Failed</option>
        <option value="expired">Expired</option>
        <option value="">All</option>
      </select>
    </div>
  </div>

  <div id="approvals-table-wrap">
    <table>
      <thead>
        <tr>
          <th onclick="sortBy('action_intent')">Intent</th>
          <th onclick="sortBy('approval_status')">Status</th>
          <th onclick="sortBy('chain')">Chain Progress</th>
          <th onclick="sortBy('operator_id')">Operator</th>
          <th onclick="sortBy('created_at')">Created</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="approvals-body"></tbody>
    </table>
    <div id="empty-state" class="empty-state" style="display:none;">No approvals found.</div>
  </div>

  <div class="pagination">
    <span id="page-info"></span>
    <div style="display:flex;gap:8px;">
      <button id="prev-btn" onclick="prevPage()" disabled>← Previous</button>
      <button id="next-btn" onclick="nextPage()">Next →</button>
    </div>
  </div>
</div>

<!-- Chain Templates Tab -->
<div class="main" id="tab-chains" style="display:none;">
  <div class="table-header">
    <h2>Chain Templates</h2>
    <div style="font-size:13px;color:var(--text-dim)">Define multi-step approval routing with sequential and parallel steps</div>
  </div>
  <div id="templates-grid" class="template-grid"></div>
  <div id="templates-empty" class="empty-state" style="display:none;">No chain templates configured.</div>
</div>

<!-- Dashboard Tab -->
<div class="main" id="tab-dashboard" style="display:none;">
  <h2 style="font-size:16px;font-weight:600;margin-bottom:16px;">Operational Dashboard</h2>

  <div class="stats-grid" id="stats-grid">
    <div class="stat-card"><div class="label">Pending Approvals</div><div class="value pending" id="s-pending">—</div></div>
    <div class="stat-card"><div class="label">Success Rate</div><div class="value success" id="s-success-rate">—</div></div>
    <div class="stat-card"><div class="label">Dispatch Retries</div><div class="value neutral" id="s-retries">—</div></div>
    <div class="stat-card"><div class="label">Avg Approval Time</div><div class="value neutral" id="s-avg-time">—</div></div>
  </div>

  <div class="stats-grid">
    <div class="stat-card"><div class="label">Approvals Created</div><div class="value neutral" id="s-created">—</div></div>
    <div class="stat-card"><div class="label">Approved</div><div class="value success" id="s-approved">—</div></div>
    <div class="stat-card"><div class="label">Rejected</div><div class="value failure" id="s-rejected">—</div></div>
    <div class="stat-card"><div class="label">Expired</div><div class="value neutral" id="s-expired">—</div></div>
  </div>

  <div class="stats-grid">
    <div class="stat-card"><div class="label">Dispatch Success</div><div class="value success" id="s-d-success">—</div></div>
    <div class="stat-card"><div class="label">Dispatch Failure</div><div class="value failure" id="s-d-failure">—</div></div>
    <div class="stat-card"><div class="label">Avg Dispatch Latency</div><div class="value neutral" id="s-d-latency">—</div></div>
    <div class="stat-card"><div class="label">Active Chain Steps</div><div class="value pending" id="s-chain-steps">—</div></div>
  </div>

  <h2 style="font-size:16px;font-weight:600;margin:24px 0 12px;">Recent Dispatches</h2>
  <table>
    <thead>
      <tr>
        <th>Intent</th>
        <th>Status</th>
        <th>Operator</th>
        <th>Dispatched</th>
      </tr>
    </thead>
    <tbody id="dispatch-body"></tbody>
  </table>
  <div id="dispatch-empty" class="empty-state" style="display:none;">No recent dispatches.</div>
</div>

<!-- Detail slide-out panel -->
<div class="detail-overlay" id="detail-overlay" onclick="closeDetail(event)">
  <div class="detail-panel" id="detail-panel" onclick="event.stopPropagation()">
    <h3>
      <span id="detail-title">Approval Detail</span>
      <button class="detail-close" onclick="closeDetail()">✕</button>
    </h3>
    <div id="detail-content"></div>
  </div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<script>
// ── State ─────────────────────────────────────────────────────────────────
let currentPage = 0;
const PAGE_SIZE = 20;
let sortField = "created_at";
let sortDir = -1; // -1 = newest first
let approvals = [];
let authenticated = false;
let userRole = null; // 'admin' | 'viewer' | null

// ── API helpers ───────────────────────────────────────────────────────────
function getCookie(name) {
  const m = document.cookie.match(new RegExp("(?:^|; )" + name + "=([^;]*)"));
  return m ? decodeURIComponent(m[1]) : null;
}

function authHeaders() {
  const headers = { "Content-Type": "application/json" };
  const token = getCookie("pj_token") || localStorage.getItem("pj_token");
  if (token) headers["Authorization"] = "Bearer " + token;
  const csrf = getCookie("csrf_token");
  if (csrf) headers["x-csrf-token"] = csrf;
  return headers;
}

async function api(path, opts = {}) {
  const res = await fetch(path, { headers: authHeaders(), ...opts });
  if (res.status === 401 || res.status === 403) {
    showAuthGate();
    throw new Error("Unauthorized");
  }
  return res.json();
}

// ── Auth gate ─────────────────────────────────────────────────────────────
function showAuthGate() {
  authenticated = false;
  document.getElementById("auth-gate").style.display = "flex";
  document.querySelectorAll(".main").forEach(el => el.style.display = "none");
  document.querySelector(".tabs").style.display = "none";
}

function hideAuthGate() {
  authenticated = true;
  document.getElementById("auth-gate").style.display = "none";
  document.querySelector(".tabs").style.display = "flex";
  // Apply role class
  if (userRole && userRole !== "admin") {
    document.body.classList.add("role-viewer");
  } else {
    document.body.classList.remove("role-viewer");
  }
  // Show the active tab
  const active = document.querySelector(".tab.active").dataset.tab;
  switchTab(active);
}

// ── Tabs ──────────────────────────────────────────────────────────────────
function switchTab(tab) {
  document.querySelectorAll(".tab").forEach(t => t.classList.toggle("active", t.dataset.tab === tab));
  document.querySelectorAll(".main").forEach(el => el.style.display = "none");
  const el = document.getElementById("tab-" + tab);
  if (el) el.style.display = "block";
  if (tab === "dashboard") loadStats();
  if (tab === "chains") loadTemplates();
}

// ── Approval Queue ────────────────────────────────────────────────────────
async function loadApprovals() {
  const status = document.getElementById("status-filter").value;
  const qs = status ? `?status=${status}&limit=${PAGE_SIZE}&offset=${currentPage * PAGE_SIZE}` :
                       `?limit=${PAGE_SIZE}&offset=${currentPage * PAGE_SIZE}`;
  try {
    const json = await api("/api/approvals" + qs);
    if (!json.success) { showToast(json.error || "Failed to load", "error"); return; }
    hideAuthGate();
    approvals = json.data.approvals;
    renderApprovals();
    renderPagination(json.data.pendingCount, json.data.total);
  } catch (e) {
    if (e.message !== "Unauthorized") showToast("Failed to load approvals", "error");
  }
}

function renderApprovals() {
  const tbody = document.getElementById("approvals-body");
  const empty = document.getElementById("empty-state");
  if (approvals.length === 0) {
    tbody.innerHTML = "";
    empty.style.display = "block";
    return;
  }
  empty.style.display = "none";

  // Sort client-side
  const sorted = [...approvals].sort((a, b) => {
    let va = a[sortField], vb = b[sortField];
    if (sortField === "chain") {
      va = a.chainSummary ? a.chainSummary.completedSteps : -1;
      vb = b.chainSummary ? b.chainSummary.completedSteps : -1;
    }
    if (va < vb) return -1 * sortDir;
    if (va > vb) return 1 * sortDir;
    return 0;
  });

  tbody.innerHTML = sorted.map(a => {
    const chain = a.chainSummary;
    let chainHtml;
    if (chain) {
      // Show parallel-aware progress: multiple active steps shown
      const activeCount = chain.activeSteps || 0;
      const parallelHint = activeCount > 1 ? ` <span style="color:var(--purple);font-size:10px" title="${activeCount} steps active in parallel">⊕${activeCount}</span>` : "";
      chainHtml = `<div class="chain-progress">
           <div class="chain-bar"><div class="chain-bar-fill" style="width:${(chain.completedSteps / chain.totalSteps * 100)}%"></div></div>
           <span>${chain.completedSteps}/${chain.totalSteps}${parallelHint}</span>
           ${chain.currentStepLabel ? `<span style="color:var(--text-dim)">· ${esc(chain.currentStepLabel)}</span>` : ""}
         </div>`;
    } else {
      chainHtml = `<span style="color:var(--text-dim)">—</span>`;
    }

    const actions = [];
    if (a.approval_status === "pending") {
      actions.push(`<button class="btn btn-approve" onclick="decide('${a.id}','approved')">Approve</button>`);
      actions.push(`<button class="btn btn-reject" onclick="decide('${a.id}','rejected')">Reject</button>`);
    }
    if (a.approval_status === "approved") {
      actions.push(`<button class="btn btn-dispatch" onclick="dispatch('${a.id}')">Dispatch</button>`);
    }

    return `<tr onclick="showDetail('${a.id}')" style="cursor:pointer">
      <td>${esc(a.action_intent || "—")}</td>
      <td><span class="status-badge ${a.approval_status}">${a.approval_status}</span></td>
      <td>${chainHtml}</td>
      <td>${esc(a.operator_id || "—")}</td>
      <td>${timeAgo(a.created_at)}</td>
      <td class="actions" onclick="event.stopPropagation()">${actions.join("") || "—"}</td>
    </tr>`;
  }).join("");
}

function renderPagination(pendingCount, total) {
  document.getElementById("page-info").textContent =
    `Showing ${approvals.length} result${approvals.length !== 1 ? "s" : ""} · ${pendingCount} pending total`;
  document.getElementById("prev-btn").disabled = currentPage === 0;
  document.getElementById("next-btn").disabled = approvals.length < PAGE_SIZE;
}

function prevPage() { if (currentPage > 0) { currentPage--; loadApprovals(); } }
function nextPage() { currentPage++; loadApprovals(); }
function sortBy(field) {
  if (sortField === field) sortDir *= -1;
  else { sortField = field; sortDir = field === "created_at" ? -1 : 1; }
  renderApprovals();
}

// ── Decide / Dispatch ─────────────────────────────────────────────────────
async function decide(id, status) {
  try {
    const json = await api(`/api/approvals/${id}/decide`, {
      method: "POST",
      body: JSON.stringify({ status }),
    });
    if (!json.success) { showToast(json.error || "Decision failed", "error"); return; }
    showToast(`Approval ${status}`, "success");
    loadApprovals();
  } catch (e) {
    if (e.message !== "Unauthorized") showToast("Decision failed", "error");
  }
}

async function dispatch(id) {
  try {
    const json = await api(`/api/approvals/${id}/dispatch`, {
      method: "POST",
      body: JSON.stringify({}),
    });
    if (!json.success) { showToast(json.error || "Dispatch failed", "error"); return; }
    showToast("Dispatched successfully", "success");
    loadApprovals();
  } catch (e) {
    if (e.message !== "Unauthorized") showToast("Dispatch failed", "error");
  }
}

// ── Detail panel ──────────────────────────────────────────────────────────
async function showDetail(id) {
  const overlay = document.getElementById("detail-overlay");
  const content = document.getElementById("detail-content");
  overlay.classList.add("open");

  content.innerHTML = "<p>Loading…</p>";

  try {
    const [approvalJson, chainJson] = await Promise.all([
      api(`/api/approvals/${id}`),
      api(`/api/approvals/${id}/chain`).catch(() => null),
    ]);

    if (!approvalJson.success) { content.innerHTML = "<p>Failed to load</p>"; return; }
    const a = approvalJson.data;
    const chain = chainJson?.data;

    let html = `
      <div class="detail-section">
        <h4>Overview</h4>
        <div class="detail-field"><span class="lbl">ID</span><span style="font-family:var(--mono);font-size:12px">${esc(a.id)}</span></div>
        <div class="detail-field"><span class="lbl">Status</span><span class="status-badge ${a.approval_status}">${a.approval_status}</span></div>
        <div class="detail-field"><span class="lbl">Intent</span><span>${esc(a.action_intent || "—")}</span></div>
        <div class="detail-field"><span class="lbl">Mode</span><span>${esc(a.action_mode || "—")}</span></div>
        <div class="detail-field"><span class="lbl">Operator</span><span>${esc(a.operator_id || "—")}</span></div>
        <div class="detail-field"><span class="lbl">Created</span><span>${new Date(a.created_at).toLocaleString()}</span></div>
        <div class="detail-field"><span class="lbl">Expires</span><span>${new Date(a.expires_at).toLocaleString()}</span></div>
        ${a.approver_id ? `<div class="detail-field"><span class="lbl">Approver</span><span>${esc(a.approver_id)}</span></div>` : ""}
        ${a.approval_note ? `<div class="detail-field"><span class="lbl">Note</span><span>${esc(a.approval_note)}</span></div>` : ""}
      </div>`;

    if (chain) {
      // Group steps by order for parallel visualization
      const stepsByOrder = {};
      chain.steps.forEach(s => {
        if (!stepsByOrder[s.order]) stepsByOrder[s.order] = [];
        stepsByOrder[s.order].push(s);
      });

      html += `
        <div class="detail-section">
          <h4>Chain Progress — ${esc(chain.templateName)}</h4>
          <div class="chain-progress" style="margin-bottom:8px">
            <div class="chain-bar" style="max-width:100%"><div class="chain-bar-fill" style="width:${(chain.completedSteps / chain.totalSteps * 100)}%"></div></div>
            <span>${chain.completedSteps} of ${chain.totalSteps} steps complete</span>
          </div>
          <ul class="chain-steps-list">
            ${chain.steps.map(s => {
              const siblings = stepsByOrder[s.order];
              const isParallel = siblings && siblings.length > 1;
              return `
              <li>
                <span class="step-dot ${s.status}"></span>
                <span>
                  <strong>${esc(s.label)}</strong>
                  ${isParallel ? '<span style="color:var(--purple);font-size:10px;margin-left:4px" title="Parallel step">⊕</span>' : ''}
                  — <span class="status-badge ${s.status}">${s.status}</span>
                </span>
                ${s.deciderId ? `<span style="color:var(--text-dim);margin-left:auto;font-size:12px">${esc(s.deciderId)} · ${timeAgo(s.decidedAt)}</span>` : ""}
              </li>`;
            }).join("")}
          </ul>
        </div>`;
    }

    if (a.plan && Array.isArray(a.plan)) {
      html += `
        <div class="detail-section">
          <h4>Plan (${a.plan.length} step${a.plan.length !== 1 ? "s" : ""})</h4>
          <pre style="background:var(--surface);padding:12px;border-radius:var(--radius);font-size:12px;font-family:var(--mono);overflow-x:auto;max-height:300px;white-space:pre-wrap">${esc(JSON.stringify(a.plan, null, 2))}</pre>
        </div>`;
    }

    if (a.dispatchResult) {
      html += `
        <div class="detail-section">
          <h4>Dispatch Result</h4>
          <pre style="background:var(--surface);padding:12px;border-radius:var(--radius);font-size:12px;font-family:var(--mono);overflow-x:auto;max-height:300px;white-space:pre-wrap">${esc(JSON.stringify(a.dispatchResult, null, 2))}</pre>
        </div>`;
    }

    // Action buttons in detail
    if (a.approval_status === "pending") {
      html += `
        <div style="display:flex;gap:8px;margin-top:16px">
          <button class="btn btn-approve" onclick="decide('${a.id}','approved');closeDetail()">Approve</button>
          <button class="btn btn-reject" onclick="decide('${a.id}','rejected');closeDetail()">Reject</button>
        </div>`;
    }
    if (a.approval_status === "approved") {
      html += `
        <div style="margin-top:16px">
          <button class="btn btn-dispatch" onclick="dispatch('${a.id}');closeDetail()">Dispatch</button>
        </div>`;
    }

    content.innerHTML = html;
  } catch (e) {
    if (e.message !== "Unauthorized") content.innerHTML = "<p>Failed to load details</p>";
  }
}

function closeDetail(e) {
  if (e && e.target !== document.getElementById("detail-overlay")) return;
  document.getElementById("detail-overlay").classList.remove("open");
}

// ── Chain Templates ───────────────────────────────────────────────────────
async function loadTemplates() {
  try {
    const json = await api("/api/chain-templates");
    if (!json.success) { showToast(json.error || "Failed to load templates", "error"); return; }
    hideAuthGate();
    renderTemplates(json.data);
  } catch (e) {
    if (e.message !== "Unauthorized") showToast("Failed to load templates", "error");
  }
}

function renderTemplates(templates) {
  const grid = document.getElementById("templates-grid");
  const empty = document.getElementById("templates-empty");
  if (!templates || templates.length === 0) {
    grid.innerHTML = "";
    empty.style.display = "block";
    return;
  }
  empty.style.display = "none";

  grid.innerHTML = templates.map(t => {
    const steps = t.steps || [];
    // Group by order for parallel visualization
    const byOrder = {};
    steps.forEach(s => {
      if (!byOrder[s.order]) byOrder[s.order] = [];
      byOrder[s.order].push(s);
    });
    const orders = Object.keys(byOrder).sort((a, b) => Number(a) - Number(b));

    let vizHtml = "";
    orders.forEach((ord, i) => {
      const group = byOrder[ord];
      if (i > 0) vizHtml += `<span class="step-arrow">→</span>`;
      if (group.length > 1) {
        // Parallel group
        vizHtml += `<div class="step-group">
          <span class="parallel-bracket">⊕ parallel</span>
          ${group.map(s => `<span class="step-pill parallel">${esc(s.label)}</span>`).join("")}
        </div>`;
      } else {
        vizHtml += `<span class="step-pill">${esc(group[0].label)}</span>`;
      }
    });

    const isDefault = t.id === "default";
    const created = t.created_at ? new Date(t.created_at).toLocaleDateString() : "";

    return `<div class="template-card">
      ${isDefault ? '<span class="template-default">Default</span>' : ""}
      <div class="template-name">${esc(t.name)}</div>
      <div class="template-id">${esc(t.id)}</div>
      <div class="template-meta">${steps.length} step${steps.length !== 1 ? "s" : ""} · ${orders.length} stage${orders.length !== 1 ? "s" : ""}${created ? " · Created " + created : ""}</div>
      <div class="template-steps-viz">${vizHtml}</div>
      <div class="template-actions">
        <button class="btn btn-secondary" onclick="showTemplateDetail('${esc(t.id)}')">View JSON</button>
        ${!isDefault ? `<button class="btn btn-danger" onclick="deleteTemplate('${esc(t.id)}')">Delete</button>` : ""}
      </div>
    </div>`;
  }).join("");
}

async function showTemplateDetail(id) {
  const overlay = document.getElementById("detail-overlay");
  const content = document.getElementById("detail-content");
  document.getElementById("detail-title").textContent = "Template Detail";
  overlay.classList.add("open");
  content.innerHTML = "<p>Loading…</p>";
  try {
    const json = await api(`/api/chain-templates/${encodeURIComponent(id)}`);
    if (!json.success) { content.innerHTML = "<p>Failed to load</p>"; return; }
    const t = json.data;
    content.innerHTML = `
      <div class="detail-section">
        <h4>Template</h4>
        <div class="detail-field"><span class="lbl">ID</span><span style="font-family:var(--mono);font-size:12px">${esc(t.id)}</span></div>
        <div class="detail-field"><span class="lbl">Name</span><span>${esc(t.name)}</span></div>
        <div class="detail-field"><span class="lbl">Steps</span><span>${(t.steps || []).length}</span></div>
      </div>
      <div class="detail-section">
        <h4>Definition</h4>
        <pre style="background:var(--surface);padding:12px;border-radius:var(--radius);font-size:12px;font-family:var(--mono);overflow-x:auto;max-height:400px;white-space:pre-wrap">${esc(JSON.stringify(t, null, 2))}</pre>
      </div>`;
  } catch (e) {
    if (e.message !== "Unauthorized") content.innerHTML = "<p>Failed to load</p>";
  }
}

async function deleteTemplate(id) {
  if (!confirm(`Delete template "${id}"?`)) return;
  try {
    const json = await api(`/api/chain-templates/${encodeURIComponent(id)}`, { method: "DELETE" });
    if (!json.success) { showToast(json.error || "Delete failed", "error"); return; }
    showToast("Template deleted", "success");
    loadTemplates();
  } catch (e) {
    if (e.message !== "Unauthorized") showToast("Delete failed", "error");
  }
}

// ── Dashboard ─────────────────────────────────────────────────────────────
async function loadStats() {
  try {
    const json = await api("/api/admin/stats");
    if (!json.success) return;
    const d = json.data;

    document.getElementById("s-pending").textContent = d.pending;

    const totalDecided = d.dispatchSuccess + d.dispatchFailure;
    const rate = totalDecided > 0 ? ((d.dispatchSuccess / totalDecided) * 100).toFixed(1) + "%" : "—";
    document.getElementById("s-success-rate").textContent = rate;

    document.getElementById("s-retries").textContent = d.dispatchRetry;
    document.getElementById("s-avg-time").textContent = d.avgApprovalTimeSec > 0 ? fmtDuration(d.avgApprovalTimeSec) : "—";

    document.getElementById("s-created").textContent = d.approvalsCreated;
    document.getElementById("s-approved").textContent = d.approvalsApproved;
    document.getElementById("s-rejected").textContent = d.approvalsRejected;
    document.getElementById("s-expired").textContent = d.approvalsExpired;

    document.getElementById("s-d-success").textContent = d.dispatchSuccess;
    document.getElementById("s-d-failure").textContent = d.dispatchFailure;
    document.getElementById("s-d-latency").textContent = d.avgDispatchLatencySec > 0 ? fmtDuration(d.avgDispatchLatencySec) : "—";
    document.getElementById("s-chain-steps").textContent = d.activeChainSteps;
  } catch (e) {
    if (e.message !== "Unauthorized") showToast("Failed to load stats", "error");
  }

  // Also load recent dispatches
  try {
    const json = await api("/api/approvals?status=dispatched&limit=20");
    if (!json.success) return;
    const dispatches = json.data.approvals;
    const tbody = document.getElementById("dispatch-body");
    const empty = document.getElementById("dispatch-empty");
    if (dispatches.length === 0) { tbody.innerHTML = ""; empty.style.display = "block"; return; }
    empty.style.display = "none";
    tbody.innerHTML = dispatches.map(a =>
      `<tr>
        <td>${esc(a.action_intent || "—")}</td>
        <td><span class="status-badge dispatched">dispatched</span></td>
        <td>${esc(a.operator_id || "—")}</td>
        <td>${timeAgo(a.dispatched_at || a.updated_at)}</td>
      </tr>`
    ).join("");
  } catch (e) { /* ignore */ }
}

// ── Utilities ─────────────────────────────────────────────────────────────
function esc(s) {
  if (!s) return "";
  const d = document.createElement("div");
  d.textContent = String(s);
  return d.innerHTML;
}

function timeAgo(iso) {
  if (!iso) return "—";
  const d = new Date(iso);
  const diff = (Date.now() - d.getTime()) / 1000;
  if (diff < 60) return "just now";
  if (diff < 3600) return Math.floor(diff / 60) + "m ago";
  if (diff < 86400) return Math.floor(diff / 3600) + "h ago";
  return Math.floor(diff / 86400) + "d ago";
}

function fmtDuration(sec) {
  if (sec < 60) return sec.toFixed(1) + "s";
  if (sec < 3600) return (sec / 60).toFixed(1) + "m";
  return (sec / 3600).toFixed(1) + "h";
}

let toastTimer;
function showToast(msg, type) {
  const el = document.getElementById("toast");
  el.textContent = msg;
  el.className = "toast show " + (type || "");
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => el.classList.remove("show"), 3000);
}

async function refresh() {
  const btn = document.getElementById("refresh-btn");
  btn.disabled = true;
  btn.textContent = "⟳ Loading…";
  try {
    const active = document.querySelector(".tab.active").dataset.tab;
    if (active === "queue") await loadApprovals();
    if (active === "dashboard") await loadStats();
    if (active === "chains") await loadTemplates();
  } finally {
    btn.disabled = false;
    btn.textContent = "⟳ Refresh";
  }
}

// ── Init ──────────────────────────────────────────────────────────────────
// Fetch user role before loading data
(async function init() {
  try {
    const meRes = await fetch("/api/me", { headers: authHeaders() });
    if (meRes.ok) {
      const me = await meRes.json();
      userRole = me.role;
    }
  } catch { /* ignore */ }
  loadApprovals();
})();
</script>
</body>
</html>
