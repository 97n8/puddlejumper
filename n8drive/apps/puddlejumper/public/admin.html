<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PuddleJumper — Control Plane Admin</title>
<link rel="stylesheet" href="/styles/pj-admin.css">

function closeDetail(e) {
  if (e && e.target !== document.getElementById("detail-overlay")) return;
  document.getElementById("detail-overlay").classList.remove("open");
}

// ── Chain Templates ───────────────────────────────────────────────────────
async function loadTemplates() {
  try {
    const json = await api("/api/chain-templates");
    if (!json.success) { showToast(json.error || "Failed to load templates", "error"); return; }
    hideAuthGate();
    renderTemplates(json.data);
  } catch (e) {
    if (e.message !== "Unauthorized") showToast("Failed to load templates", "error");
  }
}

function renderTemplates(templates) {
  const grid = document.getElementById("templates-grid");
  const empty = document.getElementById("templates-empty");
  if (!templates || templates.length === 0) {
    grid.innerHTML = "";
    empty.style.display = "block";
    return;
  }
  empty.style.display = "none";

  grid.innerHTML = templates.map(t => {
    const steps = t.steps || [];
    // Group by order for parallel visualization
    const byOrder = {};
    steps.forEach(s => {
      if (!byOrder[s.order]) byOrder[s.order] = [];
      byOrder[s.order].push(s);
    });
    const orders = Object.keys(byOrder).sort((a, b) => Number(a) - Number(b));

    let vizHtml = "";
    orders.forEach((ord, i) => {
      const group = byOrder[ord];
      if (i > 0) vizHtml += `<span class="step-arrow">→</span>`;
      if (group.length > 1) {
        // Parallel group
        vizHtml += `<div class="step-group">
          <span class="parallel-bracket">⊕ parallel</span>
          ${group.map(s => `<span class="step-pill parallel">${esc(s.label)}</span>`).join("")}
        </div>`;
      } else {
        vizHtml += `<span class="step-pill">${esc(group[0].label)}</span>`;
      }
    });

    const isDefault = t.id === "default";
    const created = t.created_at ? new Date(t.created_at).toLocaleDateString() : "";

    return `<div class="template-card">
      ${isDefault ? '<span class="template-default">Default</span>' : ""}
      <div class="template-name">${esc(t.name)}</div>
      <div class="template-id">${esc(t.id)}</div>
      <div class="template-meta">${steps.length} step${steps.length !== 1 ? "s" : ""} · ${orders.length} stage${orders.length !== 1 ? "s" : ""}${created ? " · Created " + created : ""}</div>
      <div class="template-steps-viz">${vizHtml}</div>
      <div class="template-actions">
        <button class="btn btn-secondary" onclick="showTemplateDetail('${esc(t.id)}')">View JSON</button>
        ${!isDefault ? `<button class="btn btn-danger" onclick="deleteTemplate('${esc(t.id)}')">Delete</button>` : ""}
      </div>
    </div>`;
  }).join("");
}

async function showTemplateDetail(id) {
  const overlay = document.getElementById("detail-overlay");
  const content = document.getElementById("detail-content");
  document.getElementById("detail-title").textContent = "Template Detail";
  overlay.classList.add("open");
  content.innerHTML = "<p>Loading…</p>";
  try {
    const json = await api(`/api/chain-templates/${encodeURIComponent(id)}`);
    if (!json.success) { content.innerHTML = "<p>Failed to load</p>"; return; }
    const t = json.data;
    content.innerHTML = `
      <div class="detail-section">
        <h4>Template</h4>
        <div class="detail-field"><span class="lbl">ID</span><span style="font-family:var(--mono);font-size:12px">${esc(t.id)}</span></div>
        <div class="detail-field"><span class="lbl">Name</span><span>${esc(t.name)}</span></div>
        <div class="detail-field"><span class="lbl">Steps</span><span>${(t.steps || []).length}</span></div>
      </div>
      <div class="detail-section">
        <h4>Definition</h4>
        <pre style="background:var(--surface);padding:12px;border-radius:var(--radius);font-size:12px;font-family:var(--mono);overflow-x:auto;max-height:400px;white-space:pre-wrap">${esc(JSON.stringify(t, null, 2))}</pre>
      </div>`;
  } catch (e) {
    if (e.message !== "Unauthorized") content.innerHTML = "<p>Failed to load</p>";
  }
}

async function deleteTemplate(id) {
  if (!confirm(`Delete template "${id}"?`)) return;
  try {
    const json = await api(`/api/chain-templates/${encodeURIComponent(id)}`, { method: "DELETE" });
    if (!json.success) { showToast(json.error || "Delete failed", "error"); return; }
    showToast("Template deleted", "success");
    loadTemplates();
  } catch (e) {
    if (e.message !== "Unauthorized") showToast("Delete failed", "error");
  }
}

// ── Dashboard ─────────────────────────────────────────────────────────────
async function loadStats() {
  try {
    const json = await api("/api/admin/stats");
    if (!json.success) return;
    const d = json.data;

    document.getElementById("s-pending").textContent = d.pending;

    const totalDecided = d.dispatchSuccess + d.dispatchFailure;
    const rate = totalDecided > 0 ? ((d.dispatchSuccess / totalDecided) * 100).toFixed(1) + "%" : "—";
    document.getElementById("s-success-rate").textContent = rate;

    document.getElementById("s-retries").textContent = d.dispatchRetry;
    document.getElementById("s-avg-time").textContent = d.avgApprovalTimeSec > 0 ? fmtDuration(d.avgApprovalTimeSec) : "—";

    document.getElementById("s-created").textContent = d.approvalsCreated;
    document.getElementById("s-approved").textContent = d.approvalsApproved;
    document.getElementById("s-rejected").textContent = d.approvalsRejected;
    document.getElementById("s-expired").textContent = d.approvalsExpired;

    document.getElementById("s-d-success").textContent = d.dispatchSuccess;
    document.getElementById("s-d-failure").textContent = d.dispatchFailure;
    document.getElementById("s-d-latency").textContent = d.avgDispatchLatencySec > 0 ? fmtDuration(d.avgDispatchLatencySec) : "—";
    document.getElementById("s-chain-steps").textContent = d.activeChainSteps;
  } catch (e) {
    if (e.message !== "Unauthorized") showToast("Failed to load stats", "error");
  }

  // Also load recent dispatches
  try {
    const json = await api("/api/approvals?status=dispatched&limit=20");
    if (!json.success) return;
    const dispatches = json.data.approvals;
    const tbody = document.getElementById("dispatch-body");
    const empty = document.getElementById("dispatch-empty");
    if (dispatches.length === 0) { tbody.innerHTML = ""; empty.style.display = "block"; return; }
    empty.style.display = "none";
    tbody.innerHTML = dispatches.map(a =>
      `<tr>
        <td>${esc(a.action_intent || "—")}</td>
        <td><span class="status-badge dispatched">dispatched</span></td>
        <td>${esc(a.operator_id || "—")}</td>
        <td>${timeAgo(a.dispatched_at || a.updated_at)}</td>
      </tr>`
    ).join("");
  } catch (e) { /* ignore */ }
}

// ── Utilities ─────────────────────────────────────────────────────────────
function esc(s) {
  if (!s) return "";
  const d = document.createElement("div");
  d.textContent = String(s);
  return d.innerHTML;
}

function timeAgo(iso) {
  if (!iso) return "—";
  const d = new Date(iso);
  const diff = (Date.now() - d.getTime()) / 1000;
  if (diff < 60) return "just now";
  if (diff < 3600) return Math.floor(diff / 60) + "m ago";
  if (diff < 86400) return Math.floor(diff / 3600) + "h ago";
  return Math.floor(diff / 86400) + "d ago";
}

function fmtDuration(sec) {
  if (sec < 60) return sec.toFixed(1) + "s";
  if (sec < 3600) return (sec / 60).toFixed(1) + "m";
  return (sec / 3600).toFixed(1) + "h";
}

let toastTimer;
function showToast(msg, type) {
  const el = document.getElementById("toast");
  el.textContent = msg;
  el.className = "toast show " + (type || "");
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => el.classList.remove("show"), 3000);
}

async function refresh() {
  const btn = document.getElementById("refresh-btn");
  btn.disabled = true;
  btn.textContent = "⟳ Loading…";
  try {
    const active = document.querySelector(".tab.active").dataset.tab;
    if (active === "queue") await loadApprovals();
    if (active === "dashboard") await loadStats();
    if (active === "chains") await loadTemplates();
  } finally {
    btn.disabled = false;
    btn.textContent = "⟳ Refresh";
  }
}

// ── Init ──────────────────────────────────────────────────────────────────
// Fetch user role and workspace before loading data
(async function init() {
  try {
    const meRes = await fetch("/api/me", { headers: authHeaders() });
    if (meRes.ok) {
      const me = await meRes.json();
      userRole = me.role;
      if (me.workspaceName) {
        const ws = document.getElementById("workspace-name");
        ws.textContent = me.workspaceName;
        ws.style.display = "inline";
      }
    }
  } catch { /* ignore */ }
  loadApprovals();
})();
</script>
</body>
</html>
