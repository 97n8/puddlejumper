name: CI

on:
  push:
    branches: ["main", "master"]
  pull_request:
    branches: ["main", "master"]

jobs:
  build-and-test:
    name: Build, lint, monorepo build & Docker smoke
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js 20.x
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"

      - name: Enable corepack/pnpm
        run: |
          corepack enable
          corepack prepare pnpm@8.15.8 --activate
          pnpm --version

      - name: Install dependencies (frozen lockfile)
        run: pnpm install --frozen-lockfile

      - name: Lint frontend (if present)
        working-directory: ./web
        if: ${{ always() && (exists('web/package.json')) }}
        run: |
          pnpm --filter web -w run -s lint || echo "No lint script or lint failed"

      - name: Typecheck (root)
        run: pnpm run typecheck

      - name: Contract check
        run: pnpm run check:pj-contract

      - name: Build core package
        run: pnpm --filter @publiclogic/core run build

      - name: Unit tests – core
        run: pnpm --filter @publiclogic/core run test

      - name: Unit tests – puddlejumper
        run: pnpm --filter @publiclogic/puddlejumper run test

      - name: Config validation (startup schema) 
        run: |
          node -e "
            process.env.JWT_SECRET = 'ci-test-secret';
            process.env.AUTH_ISSUER = 'ci-issuer';
            process.env.AUTH_AUDIENCE = 'ci-audience';
            process.env.PRR_DB_PATH = '/app/data/prr.db';
            process.env.CONNECTOR_DB_PATH = '/app/data/connectors.db';
            import('./apps/puddlejumper/dist/api/startupConfig.js').then(m => {
              m.loadConfig();
              console.log('✓ Config validation passed');
            });
          "

      - name: Monorepo build (root)
        run: pnpm run build

      - name: Create CI env file
        run: |
          cat > .env.ci <<'EOF'
          NODE_ENV=production
          PORT=3002
          JWT_SECRET=ci-test-secret-min-32-chars-long-0000000000
          CONNECTOR_STATE_SECRET=ci-test-connector-secret
          ACCESS_NOTIFICATION_WEBHOOK_URL=http://localhost:9999/noop
          CONTROLLED_DATA_DIR=/app/data
          EOF

      - name: Build Docker image
        run: |
          docker build -t publiclogic/puddlejumper:ci .

      - name: Run container for smoke test
        run: |
          docker rm -f pj-ci || true
          docker run -d --name pj-ci --env-file .env.ci -p 3002:3002 publiclogic/puddlejumper:ci
          echo "Waiting for /health (max 60s)..."
          for i in $(seq 1 60); do
            if curl -s -o /dev/null -w "%{http_code}" http://localhost:3002/health | grep -q 200; then
              echo "Health OK"
              exit 0
            fi
            sleep 1
          done
          echo "Health check failed; dumping container logs:"
          docker logs pj-ci --tail 200 || true
          docker rm -f pj-ci || true
          exit 1

      - name: Stop and cleanup container
        if: success()
        run: |
          docker logs pj-ci --tail 80 || true
          docker rm -f pj-ci || true

      - name: Upload docker image (optional)
        if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
        uses: docker/build-push-action@v4
        with:
          push: false
          tags: publiclogic/puddlejumper:ci

  validate-alerts:
    name: Validate Prometheus alert rules
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install promtool
        run: |
          PROM_VERSION="2.51.0"
          curl -sL "https://github.com/prometheus/prometheus/releases/download/v${PROM_VERSION}/prometheus-${PROM_VERSION}.linux-amd64.tar.gz" | tar xzf -
          sudo mv "prometheus-${PROM_VERSION}.linux-amd64/promtool" /usr/local/bin/
          promtool --version

      - name: Lint alert rules
        run: |
          if [ -f ops/alerts/approval-alerts.yml ]; then
            promtool check rules ops/alerts/approval-alerts.yml
            echo "✓ Alert rules valid"
          else
            echo "⊘ No alert rules found — skipping"
          fi
