<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<meta http-equiv="Content-Security-Policy" content="default-src 'self'; base-uri 'none'; object-src 'none'; frame-ancestors 'self'; form-action 'self'; connect-src 'self'; img-src 'self' data:; font-src 'self'; style-src 'sha256-UnQ9WLPmRTOlxnhAYkES7bbagOpjnZ7K+uzH797IRXg='; script-src 'sha256-RaAFDNcvel+HVs17UEusCl3eVeU+NLTdgsA08bPtjwc=';">
<meta name="pj-trusted-parent-origins" content="">
<title>PuddleJumper â€” Simple Governance Showcase</title>
<style>
:root{
  --bg:#0f172a; --panel:#1e293b; --card:#334155; --text:#e2e8f0; --muted:#94a3b8;
  --primary:#60a5fa; --accent:#a78bfa; --success:#34d399; --danger:#ef4444; --border:#475569; --warn:#fbbf24;
}
*{box-sizing:border-box}
body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text);height:100vh;display:flex;flex-direction:column}
header{padding:14px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;background:#020617}
h1{margin:0;font-size:16px;display:flex;align-items:center;gap:10px}
.header-actions{display:flex;gap:10px;align-items:center}
button{padding:8px 12px;border-radius:8px;border:0;background:var(--card);color:var(--text);cursor:pointer;font-size:13px}
button.primary{background:var(--primary);color:#04233a}
button.ghost{background:transparent;border:1px solid var(--border)}
button.destructive{background:var(--danger);color:#00121a}
button:disabled{opacity:.55;cursor:not-allowed}
select,input{padding:9px;border-radius:8px;border:1px solid var(--border);background:var(--card);color:var(--text)}
.main{flex:1;display:flex;overflow:hidden}
.navigator{width:420px;background:var(--panel);border-right:1px solid var(--border);display:flex;flex-direction:column}
.controls{padding:16px;border-bottom:1px solid var(--border);display:flex;flex-direction:column;gap:10px}
.tree{flex:1;overflow:auto;padding:12px}
.details{flex:1;padding:20px;overflow:auto}
.card{background:var(--card);border-radius:12px;padding:16px;margin-bottom:16px}
.item-row{padding:10px 12px;border-radius:8px;display:flex;justify-content:space-between;align-items:center;cursor:pointer}
.item-row:hover{background:#3e5574}
.item-row.selected{background:var(--primary);color:#021124;font-weight:600}
.meta{font-size:12px;color:var(--muted)}
.audit{background:#18202a;padding:12px;border-radius:8px;max-height:320px;overflow:auto;font-size:13px;color:var(--muted);line-height:1.5}
.small{font-size:12px;color:var(--muted)}
.modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.45);display:none;align-items:center;justify-content:center;z-index:999}
.modal{width:420px;background:#0b1220;padding:18px;border-radius:10px;border:1px solid var(--border)}
.form-row{display:flex;flex-direction:column;gap:6px;margin-bottom:10px}
.form-row label{font-size:13px;color:var(--muted)}
.form-row input,.form-row select{width:100%}
.row{display:flex;gap:8px;align-items:center}
.header-env{display:flex;align-items:center;gap:6px}
.header-role{display:flex;flex-direction:column;align-items:flex-end}
.status-pill{background:var(--accent);padding:6px 10px;border-radius:999px;color:#081426;font-weight:600}
.help{font-size:13px;color:var(--muted)}
.footer-note{font-size:12px;color:var(--muted);text-align:center;margin-top:8px}
.control-row{display:flex;gap:8px}
.action-row{display:flex;gap:10px}
.modal-actions{display:flex;justify-content:flex-end;gap:10px;margin-top:8px}
.chain-ok{color:var(--success);font-weight:600}
.chain-bad{color:var(--danger);font-weight:600}
.legal-hold-yes{color:var(--warn);font-weight:700}
.live-status-ok{color:var(--success)}
.live-status-bad{color:var(--danger)}
.icon{display:inline-block;min-width:16px;text-align:center;margin-right:6px;font-style:normal}
.link-open{color:var(--primary);text-decoration:none}
.link-open:hover{text-decoration:underline}
</style>
</head>
<body>
<header>
  <h1><i class="icon" data-lucide="shield"></i> PuddleJumper</h1>
  <div class="header-actions">
    <div class="header-env">
      <select id="envSelect" title="Environment"></select>
      <button id="newEnvBtn" class="ghost" title="New environment">+</button>
    </div>

    <div class="header-role">
      <select id="roleSelect" class="role-select" title="Role">
        <option>Viewer</option><option>Clerk</option><option>Chair</option><option>Auditor</option><option>Legal</option>
      </select>
      <div class="small">Role controls what you can do â€” try Clerk or Chair for edits.</div>
    </div>

    <button id="newItemBtn" class="primary"><i class="icon" data-lucide="plus"></i> New</button>
    <span id="status" class="small status-pill">0 items</span>
  </div>
</header>

<div class="main">
  <div class="navigator">
    <div class="controls">
      <div class="control-row">
        <select id="mode"><option value="connector">Connectors</option><option value="project">Projects</option></select>
        <select id="connector"><option value="ALL">All</option><option>GitHub</option><option>Drive</option><option>SharePoint</option><option>Bookmarks</option></select>
      </div>
      <input id="search" placeholder="Search name, project, tagsâ€¦" />
      <div class="small help">Tip: use the role selector to demonstrate gating (Chair approves).</div>
      <div id="liveSourceStatus" class="small">Live sources: loading...</div>
    </div>
    <div class="tree" id="tree"></div>
  </div>

  <div class="details">
    <div class="card" id="detailsCard"><div class="small">Select an item to view details</div></div>

    <div class="card actions">
      <div class="action-row">
        <button id="openBtn" disabled><i class="icon" data-lucide="external-link"></i> Open</button>
        <button id="copyBtn" disabled><i class="icon" data-lucide="copy"></i> Copy</button>
        <button id="editBtn" disabled><i class="icon" data-lucide="edit-2"></i> Edit</button>
        <button id="deleteBtn" disabled class="destructive"><i class="icon" data-lucide="trash-2"></i> Delete</button>
      </div>
    </div>

    <div class="card">
      <strong><i class="icon" data-lucide="history"></i> Recent Activity</strong>
      <div id="chainStatus" class="small"></div>
      <div class="audit" id="audit">No activity yet</div>
      <div class="footer-note">Audit is immutable (SHA-256 chain). In Showcase mode data is ephemeral.</div>
    </div>
  </div>
</div>

<div id="modalBackdrop" class="modal-backdrop" role="dialog" aria-modal="true">
  <div class="modal" role="document" aria-labelledby="modalTitle">
    <strong id="modalTitle">New Item</strong>
    <form id="modalForm">
      <div class="form-row"><label>Name</label><input id="f_name" required /></div>
      <div class="form-row"><label>Type</label>
        <select id="f_type"><option value="document">document</option><option value="repo">repo</option><option value="record">record</option><option value="link">link</option><option value="folder">folder</option></select>
      </div>
      <div class="form-row"><label>Project (optional)</label><input id="f_project" /></div>
      <div class="form-row"><label>URL (optional)</label><input id="f_url" /></div>
      <div class="form-row"><label>Approval</label>
        <select id="f_approval"><option value="">â€”</option><option>draft</option><option>pending</option><option>approved</option><option>rejected</option></select>
      </div>
      <div class="form-row"><label>Retention (e.g., 7y, 6m, 30d, permanent)</label><input id="f_retention" /></div>
      <div class="form-row"><label><input type="checkbox" id="f_legal"/> Legal hold (prevents deletion)</label></div>
      <div class="form-row"><label>Tags (comma separated)</label><input id="f_tags" /></div>
      <div class="modal-actions">
        <button type="button" id="modalCancel">Cancel</button>
        <button type="submit" id="modalSave" class="primary">Save</button>
      </div>
    </form>
  </div>
</div>

<script>
function today(){ return new Date().toISOString().split('T')[0]; }
function uuid(){ return crypto && crypto.randomUUID ? crypto.randomUUID() : 'id_'+Math.random().toString(36).slice(2); }
function safeParse(k, fallback){ try{ return JSON.parse(localStorage.getItem(k) || 'null') || fallback; }catch{ return fallback; } }
function qparam(n,f){ try{ const p=new URLSearchParams(location.search); return p.get(n)||f; }catch{return f;} }

const ICON_MAP = {
  shield: 'ðŸ›¡', plus: '+', 'external-link': 'â†—', copy: 'â§‰', 'edit-2': 'âœŽ', 'trash-2': 'ðŸ—‘',
  history: 'â±', folder: 'ðŸ“', 'folder-open': 'ðŸ“‚', github: 'âŒ‚', 'file-text': 'ðŸ“„',
  'file-check': 'âœ…', link: 'ðŸ”—', 'arrow-left': 'â†'
};
function renderIcons(root){
  const scope = root || document;
  scope.querySelectorAll('i[data-lucide]').forEach((el)=>{
    const key = String(el.getAttribute('data-lucide') || '');
    el.textContent = ICON_MAP[key] || 'â€¢';
    el.classList.add('icon');
    el.setAttribute('aria-hidden','true');
  });
}

function clearEl(el){ while(el.firstChild) el.removeChild(el.firstChild); }
function textEl(tag, text, className){ const el=document.createElement(tag); if(className) el.className=className; el.textContent=String(text==null?'':text); return el; }
function appendIconLabel(parent, iconKey, label){ const icon=document.createElement('i'); icon.setAttribute('data-lucide',iconKey); icon.className='icon'; parent.appendChild(icon); parent.appendChild(document.createTextNode(String(label))); }
function normalizeConnectorName(name){
  const n=String(name||'').toLowerCase();
  if(n.includes('github')) return 'GitHub';
  if(n.includes('sharepoint')) return 'SharePoint';
  if(n.includes('drive')||n.includes('google')) return 'Drive';
  if(n.includes('bookmark')) return 'Bookmarks';
  return null;
}

function normalizeConnectorFromUnknown(value){
  if(typeof value==='string') return normalizeConnectorName(value);
  if(!value || typeof value!=='object') return null;
  const obj = value;
  return normalizeConnectorName(obj.connector || obj.provider || obj.name || obj.type || obj.system || '');
}

function registerConnectorFromMap(mapLike, collector){
  if(!mapLike || typeof mapLike!=='object' || Array.isArray(mapLike)) return;
  Object.entries(mapLike).forEach(([key, value])=>{
    if(typeof value === 'boolean'){
      if(value){
        const normalized = normalizeConnectorName(key);
        if(normalized) collector(normalized);
      }
      return;
    }
    if(typeof value === 'string'){
      const normalized = normalizeConnectorName(value) || normalizeConnectorName(key);
      if(normalized) collector(normalized);
      return;
    }
    if(value && typeof value === 'object'){
      const isEnabled = (typeof value.enabled === 'boolean') ? value.enabled : true;
      if(!isEnabled) return;
      const normalized = normalizeConnectorFromUnknown(value) || normalizeConnectorName(key);
      if(normalized) collector(normalized);
    }
  });
}

const ROLE_PERMS = {
  Viewer:{create:false,edit:false,delete:false,approve:false,log:false},
  Clerk:{create:true,edit:true,delete:false,approve:false,log:true},
  Chair:{create:true,edit:true,delete:true,approve:true,log:true},
  Auditor:{create:false,edit:false,delete:false,approve:false,log:true},
  Legal:{create:false,edit:false,delete:false,approve:false,log:true}
};
let currentRole = 'Clerk';
const roleSelectEl=document.getElementById('roleSelect');
roleSelectEl.value=currentRole;
roleSelectEl.onchange=()=>{ currentRole = roleSelectEl.value; updateActions(); };

const ITEM_SCHEMA={ type:'document', project:undefined, url:undefined, approvalState:undefined, retentionPolicy:undefined, legalHold:false, complianceTags:[], created:undefined, lastUpdated:undefined };
function parseRetention(p){ if(!p) return null; if(p==='permanent') return Infinity; const m=/^(\d+)([dmy])$/.exec(p); if(!m) return null; const n=Number(m[1]); const u=m[2]; return u==='d'?n:u==='m'?n*30:n*365; }
function checkRetentionAllowsDelete(item){ if(!item) return true; if(item.legalHold) return false; const pol=item.retentionPolicy; if(!pol) return true; if(pol==='permanent') return false; const days=parseRetention(pol); if(!days) return true; const created=new Date(item.created||item.lastUpdated||today()); const due=new Date(created); due.setDate(due.getDate()+days); return new Date()>=due; }

const TRANS={ draft:['pending'], pending:['approved','rejected'], approved:['archived'], rejected:[] };
function canTransition(from,to,role){ if(!from) from='draft'; if(from===to) return true; const ok=(TRANS[from]||[]).includes(to); if(!ok) return false; if(to==='approved' && role!=='Chair') return false; return true; }

const ENV_KEY='pj_envs_simple';
const DEFAULT_ENV='Showcase';
let envList = safeParse(ENV_KEY,[DEFAULT_ENV]);
let currentEnv = localStorage.getItem('pj_current_env_simple')||DEFAULT_ENV;
function getDataKey(env){ return 'pj_data_simple_'+env; }
let data = safeParse(getDataKey(currentEnv), {});
if(Object.keys(data).length===0){
  data = {
    GitHub:{type:'root',children:{ Repos:{type:'folder',children:{
      '97n8/PL':Object.assign({},ITEM_SCHEMA,{type:'repo',url:'https://github.com/97n8/PL',project:'Core',approvalState:'approved',retentionPolicy:'permanent',created:today(),lastUpdated:today()}),
      '97n8/AGNOSTIC':Object.assign({},ITEM_SCHEMA,{type:'repo',url:'https://github.com/97n8/AGNOSTIC',project:'Core',approvalState:'approved',retentionPolicy:'permanent',created:today(),lastUpdated:today()})
    }}}},
    Drive:{type:'root',children:{ Docs:{type:'folder',children:{
      'Strategy.pdf':Object.assign({},ITEM_SCHEMA,{type:'document',url:'https://example.com/strategy',project:'Planning',approvalState:'approved',retentionPolicy:'permanent',created:today(),lastUpdated:today()}),
      'Budget.xlsx':Object.assign({},ITEM_SCHEMA,{type:'document',project:'Finance',approvalState:'pending',retentionPolicy:'6m',created:today(),lastUpdated:today()})
    }}}},
    Bookmarks:{type:'root',children:{ Guide:Object.assign({},ITEM_SCHEMA,{type:'link',url:'https://example.com/guide',created:today(),lastUpdated:today()}) }}
  };
}

let audit = safeParse('pj_audit_simple',[]);
const isShowcase = (qparam('mode',null)==='showcase') || currentEnv===DEFAULT_ENV;

function saveEnvList(){ if(isShowcase) return; localStorage.setItem(ENV_KEY,JSON.stringify(envList)); }
function saveData(){ if(!isShowcase) localStorage.setItem(getDataKey(currentEnv),JSON.stringify(data)); updateStatus(); }
function saveAudit(){ if(!isShowcase) localStorage.setItem('pj_audit_simple',JSON.stringify(audit)); loadAudit(); updateChainStatus(); }

async function sha256Hex(input){ const enc=new TextEncoder(); const res=await crypto.subtle.digest('SHA-256',enc.encode(input)); return Array.from(new Uint8Array(res)).map(b=>b.toString(16).padStart(2,'0')).join(''); }
async function logActionImmutable(action,itemId){
  const time=new Date().toISOString();
  const prevHash=(audit.length && audit[audit.length-1].hash)?audit[audit.length-1].hash:'';
  const payload=JSON.stringify({time,action,itemId:itemId||null,env:currentEnv});
  const hash=await sha256Hex(prevHash+'|'+payload);
  audit.push({time,action,itemId:itemId||null,env:currentEnv,prevHash,hash});
  saveAudit();
}

const DataAPI = {
  async createItem({parentNode,name,attrs}){
    if(!ROLE_PERMS[currentRole].create){ alert('Permission denied: create'); return null; }
    if(!parentNode.children) parentNode.children={};
    const item=Object.assign({},ITEM_SCHEMA,attrs||{});
    item.created=item.created||today();
    item.lastUpdated=today();
    parentNode.children[name]=item;
    await logActionImmutable('CREATED',name);
    saveData();
    return {name,item,parentNode};
  },
  async updateItem({target,attrs,newName}){
    if(!ROLE_PERMS[currentRole].edit){ alert('Permission denied: edit'); return false; }
    if(!target||!target.item||!target.parentNode) return false;
    if(Object.prototype.hasOwnProperty.call(attrs||{},'approvalState')){
      const from=target.item.approvalState||'draft';
      const to=attrs.approvalState;
      if(!canTransition(from,to,currentRole)){ alert('Approval transition not allowed'); return false; }
    }
    Object.assign(target.item,attrs||{});
    target.item.lastUpdated=today();
    if(newName && newName!==target.name){
      if(target.parentNode.children[newName]){ alert('Name exists'); return false; }
      target.parentNode.children[newName]=target.item;
      delete target.parentNode.children[target.name];
      await logActionImmutable('RENAMED',target.name+' -> '+newName);
      target.name=newName;
    }else{
      await logActionImmutable('UPDATED',target.name);
    }
    saveData();
    return true;
  },
  async deleteItem({target}){
    if(!ROLE_PERMS[currentRole].delete){ alert('Permission denied: delete'); return false; }
    if(!target||!target.item||!target.parentNode) return false;
    if(target.item.legalHold){ alert('Cannot delete: legal hold active'); return false; }
    if(!checkRetentionAllowsDelete(target.item)){ alert('Cannot delete: retention policy active'); return false; }
    delete target.parentNode.children[target.name];
    await logActionImmutable('DELETED',target.name);
    saveData();
    return true;
  }
};

async function verifyAuditChain(){
  let prev='';
  for(const entry of audit){
    const payload=JSON.stringify({time:entry.time,action:entry.action,itemId:entry.itemId||null,env:entry.env});
    const expected=await sha256Hex(prev+'|'+payload);
    if(expected!==entry.hash) return false;
    prev=entry.hash;
  }
  return true;
}

async function updateChainStatus(){
  const ok=await verifyAuditChain();
  const cs=document.getElementById('chainStatus');
  clearEl(cs);
  const span=document.createElement('span');
  span.className = ok ? 'chain-ok' : 'chain-bad';
  span.textContent = ok ? 'Chain valid âœ…' : 'Chain broken âŒ';
  cs.appendChild(span);
}

const treeEl=document.getElementById('tree');
const detailsCard=document.getElementById('detailsCard');
const auditEl=document.getElementById('audit');
const liveSourceStatusEl=document.getElementById('liveSourceStatus');

function ensureConnectorRoot(name){
  if(!data[name]) data[name] = { type:'root', children:{} };
  if(!data[name].children) data[name].children = {};
  return data[name];
}

function ensureFolder(root, name){
  if(!root.children[name]) root.children[name] = { type:'folder', children:{} };
  if(!root.children[name].children) root.children[name].children = {};
  return root.children[name];
}

function addLiveConnection(connectorName, tenantName){
  const root = ensureConnectorRoot(connectorName);
  const folder = ensureFolder(root, 'Live Connections');
  const key = tenantName + ' connection';
  if(!folder.children[key]){
    folder.children[key] = Object.assign({}, ITEM_SCHEMA, {
      type:'record', project:'Live', approvalState:'approved', retentionPolicy:'permanent', created:today(), lastUpdated:today()
    });
  }
}

function addLiveTarget(descriptor){
  const root = ensureConnectorRoot(descriptor.connector);
  const folder = ensureFolder(root, 'Live Targets');
  if(!folder.children[descriptor.label]){
    folder.children[descriptor.label] = Object.assign({}, ITEM_SCHEMA, {
      type:descriptor.type,
      project:'Live',
      url:descriptor.url || undefined,
      approvalState:'approved',
      retentionPolicy:'permanent',
      created:today(),
      lastUpdated:today()
    });
  }
}

function parseTarget(target){
  const raw = String(target||'').trim();
  if(!raw || raw.startsWith('health:')) return null;
  if(raw.toLowerCase().startsWith('github:')){
    const repo=raw.slice(7);
    if(!repo) return null;
    return { connector:'GitHub', type:'repo', label:repo, url:'https://github.com/'+repo };
  }
  if(raw.toLowerCase().startsWith('sharepoint:')){
    const value=raw.slice(11);
    return { connector:'SharePoint', type:'record', label:value||raw, url:/^https?:\/\//i.test(value)?value:'' };
  }
  if(raw.toLowerCase().startsWith('drive:')){
    const value=raw.slice(6);
    return { connector:'Drive', type:'document', label:value||raw, url:'' };
  }
  if(/^[A-Za-z0-9_.-]+\/[A-Za-z0-9_.-]+$/.test(raw)){
    return { connector:'GitHub', type:'repo', label:raw, url:'https://github.com/'+raw };
  }
  try{
    const url = new URL(raw);
    const host = url.hostname.toLowerCase();
    if(host==='github.com' || host.endsWith('.github.com')){
      const segments = url.pathname.split('/').filter(Boolean);
      const repo = segments.length >= 2 ? segments[0] + '/' + segments[1] : raw;
      return { connector:'GitHub', type:'repo', label:repo, url:url.href };
    }
    if(host.includes('sharepoint.com')){
      const label = decodeURIComponent(url.pathname.replace(/^\/+/, '') || host);
      return { connector:'SharePoint', type:'record', label:label, url:url.href };
    }
    if(host==='drive.google.com' || host==='docs.google.com'){
      const label = decodeURIComponent(url.pathname.replace(/^\/+/, '') || raw);
      return { connector:'Drive', type:'document', label:label, url:url.href };
    }
  }catch{}
  return null;
}

async function fetchJson(path){
  const resp = await fetch(path, {
    credentials:'include',
    headers:{ 'X-PuddleJumper-Request':'true', 'Accept':'application/json' }
  });
  if(!resp.ok){
    let reason = 'request_failed';
    try{ const body = await resp.json(); reason = body.error || reason; }catch{}
    throw new Error(reason);
  }
  try{
    return await resp.json();
  }catch{
    throw new Error('invalid_json');
  }
}

async function hydrateLiveSources(){
  try{
    const [identity, tiles] = await Promise.all([
      fetchJson('/api/identity'),
      fetchJson('/api/config/tiles').catch(()=>[])
    ]);
    const tenants = Array.isArray(identity && identity.tenants) ? identity.tenants : [];
    const connectorSet = new Set();
    const registerConnector = (name, tenantName)=>{
      const normalized = normalizeConnectorName(name);
      if(!normalized) return;
      connectorSet.add(normalized);
      addLiveConnection(normalized, tenantName || 'Tenant');
    };
    tenants.forEach((tenant)=>{
      const tenantName = String(tenant && (tenant.name || tenant.id) || 'Tenant');
      const list = Array.isArray(tenant && tenant.connections) ? tenant.connections : [];
      list.forEach((connection)=> registerConnector(normalizeConnectorFromUnknown(connection), tenantName));
      const connectors = Array.isArray(tenant && tenant.connectors) ? tenant.connectors : [];
      connectors.forEach((connection)=> registerConnector(normalizeConnectorFromUnknown(connection), tenantName));
      registerConnectorFromMap(tenant && tenant.integrations, (name)=>registerConnector(name, tenantName));
    });
    const topLevelConnections = Array.isArray(identity && identity.connections) ? identity.connections : [];
    topLevelConnections.forEach((connection)=> registerConnector(normalizeConnectorFromUnknown(connection), identity && identity.tenantName));
    registerConnectorFromMap(identity && identity.integrations, (name)=>registerConnector(name, identity && identity.tenantName));
    registerConnectorFromMap(identity && identity.connectors, (name)=>registerConnector(name, identity && identity.tenantName));

    if(Array.isArray(tiles)){
      tiles.forEach((tile)=>{
        const targets=[];
        if(typeof tile.target==='string') targets.push(...tile.target.split(',').map(s=>s.trim()).filter(Boolean));
        if(Array.isArray(tile.targets)){
          tile.targets.forEach((t)=>targets.push(...String(t||'').split(',').map(s=>s.trim()).filter(Boolean)));
        }
        targets.forEach((target)=>{
          const parsed = parseTarget(target);
          if(!parsed) return;
          connectorSet.add(parsed.connector);
          addLiveTarget(parsed);
        });
      });
    }

    const totalConnectors = connectorSet.size;
    const connectorList = Array.from(connectorSet).sort();
    if(totalConnectors){
      liveSourceStatusEl.textContent = 'Live sources: ' + connectorList.join(', ') + ' (' + totalConnectors + ') from authenticated scope.';
      liveSourceStatusEl.className = 'small live-status-ok';
    }else{
      liveSourceStatusEl.textContent = 'Live sources: authenticated, but no connector metadata returned by backend.';
      liveSourceStatusEl.className = 'small live-status-bad';
    }
    renderTree();
  }catch(err){
    liveSourceStatusEl.textContent = 'Live sources unavailable: ' + (err && err.message ? err.message : 'offline');
    liveSourceStatusEl.className = 'small live-status-bad';
  }
}

function parseOrigin(value){
  try{
    const parsed = new URL(String(value || ''), window.location.origin);
    if(parsed.protocol !== 'http:' && parsed.protocol !== 'https:') return '';
    return parsed.origin;
  }catch{
    return '';
  }
}

function buildTrustedParentOrigins(){
  const allowed = new Set();
  const sameOrigin = parseOrigin(window.location.origin);
  if(sameOrigin) allowed.add(sameOrigin);
  const configured = document.querySelector('meta[name="pj-trusted-parent-origins"]');
  const configuredValue = configured ? String(configured.getAttribute('content') || '') : '';
  configuredValue.split(',').map((value)=>value.trim()).filter(Boolean).forEach((value)=>{
    const origin = parseOrigin(value);
    if(origin) allowed.add(origin);
  });
  if(window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'){
    allowed.add('http://localhost:3000');
    allowed.add('http://127.0.0.1:3000');
  }
  return allowed;
}

const ALLOWED_PARENT_ORIGINS = buildTrustedParentOrigins();
const EXPECT_PARENT_MESSAGES = window.parent !== window;
window.addEventListener('message', (event)=>{
  if(!EXPECT_PARENT_MESSAGES) return;
  if(event.source !== window.parent) return;
  if(!ALLOWED_PARENT_ORIGINS.has(event.origin)) return;
  if(!event.data || typeof event.data !== 'object') return;
  const type = String(event.data.type || '');
  if(type !== 'PJ_IDENTITY_CONTEXT' && type !== 'IDENTITY_UPDATE' && type !== 'pj.identity') return;
  if(!event.data.payload || !Array.isArray(event.data.payload.tenants)) return;
  const payload = event.data.payload;
  const tenants = payload.tenants;
  tenants.forEach((tenant)=>{
    const tenantName = String((tenant && (tenant.name || tenant.id)) || 'Tenant');
    const list = Array.isArray(tenant && tenant.connections) ? tenant.connections : [];
    list.forEach((connection)=>{
      const normalized = normalizeConnectorFromUnknown(connection);
      if(!normalized) return;
      addLiveConnection(normalized, tenantName);
    });
    registerConnectorFromMap(tenant && tenant.integrations, (name)=>addLiveConnection(name, tenantName));
  });
  liveSourceStatusEl.textContent = 'Live sources: updated from trusted parent context.';
  liveSourceStatusEl.className = 'small live-status-ok';
  renderTree();
});

function updateStatus(){
  let count=0;
  function walk(node){
    if(!node) return;
    if(node.type !== 'folder' && !node.children) count += 1;
    if(node.children) Object.values(node.children).forEach(walk);
  }
  Object.values(data).forEach(walk);
  document.getElementById('status').textContent = String(count) + ' items';
}

function renderEnvSelect(){
  const sel=document.getElementById('envSelect');
  clearEl(sel);
  envList.slice().sort().forEach((env)=>{
    const opt=document.createElement('option');
    opt.value=env;
    opt.textContent=env;
    if(env===currentEnv) opt.selected=true;
    sel.appendChild(opt);
  });
}

document.getElementById('envSelect').addEventListener('change', (e)=>{
  currentEnv=e.target.value;
  localStorage.setItem('pj_current_env_simple', currentEnv);
  data=safeParse(getDataKey(currentEnv), data);
  renderTree();
  setDetailsEmpty();
});

document.getElementById('newEnvBtn').onclick=()=>{
  if(!ROLE_PERMS[currentRole].create){ alert('No permission to create environment'); return; }
  const name=prompt('New environment name?');
  if(!name || envList.includes(name)) return;
  envList.push(name);
  saveEnvList();
  renderEnvSelect();
  currentEnv=name;
  localStorage.setItem('pj_current_env_simple',name);
  data={};
  saveData();
  renderTree();
  setDetailsEmpty();
};

function renderTree(){
  clearEl(treeEl);
  const mode=document.getElementById('mode').value;
  const q=(document.getElementById('search').value||'').toLowerCase();
  if(mode==='project'){ renderProjectMode(q); renderIcons(treeEl); return; }
  const connector=document.getElementById('connector').value;
  const names = connector==='ALL' ? Object.keys(data) : [connector];
  names.forEach((name)=>{
    const root=data[name];
    if(!root) return;
    const det=document.createElement('details');
    det.open=true;
    const summary=document.createElement('summary');
    summary.className='folder-row';
    appendIconLabel(summary,'folder',name);
    det.appendChild(summary);
    renderChildren(root, det, name, 1, q);
    treeEl.appendChild(det);
  });
  renderIcons(treeEl);
}

function renderChildren(node,parentEl,connector,depth,q){
  if(!node || !node.children) return;
  Object.entries(node.children).forEach(([key, child])=>{
    const text=String(key).toLowerCase();
    const content=JSON.stringify(child||{}).toLowerCase();
    if(q && !text.includes(q) && !content.includes(q)) return;
    if(child.type==='folder'){
      const det=document.createElement('details');
      det.open=true;
      const sum=document.createElement('summary');
      sum.style.paddingLeft=(depth*1.2)+'rem';
      sum.className='folder-row';
      appendIconLabel(sum,'folder-open',key);
      det.appendChild(sum);
      renderChildren(child, det, connector, depth+1, q);
      parentEl.appendChild(det);
    }else{
      const row=document.createElement('div');
      row.className='item-row';
      row.style.paddingLeft=(depth*1.2)+'rem';
      const left=document.createElement('span');
      appendIconLabel(left, icon(child.type), key);
      const right=document.createElement('span');
      right.className='meta';
      right.textContent=String(child.project||'');
      row.appendChild(left);
      row.appendChild(right);
      row.addEventListener('click', ()=>selectItem(child,key,node,connector,row));
      parentEl.appendChild(row);
    }
  });
}

function renderProjectMode(q){
  const projects=new Set();
  function collect(n){ if(!n) return; if(n.project) projects.add(n.project); if(n.children) Object.values(n.children).forEach(collect); }
  Object.values(data).forEach(collect);
  clearEl(treeEl);
  if(!projects.size){ treeEl.appendChild(textEl('div','No projects tagged yet','small')); return; }
  [...projects].sort().forEach((project)=>{
    if(q && !String(project).toLowerCase().includes(q)) return;
    const row=document.createElement('div');
    row.className='item-row folder-row';
    row.textContent=String(project);
    row.addEventListener('click', ()=>renderProjectItems(project));
    treeEl.appendChild(row);
  });
}

function renderProjectItems(project){
  const items=[];
  function collect(container,node,source,key){
    if(node.type!=='folder' && node.project===project) items.push({node,container,key,source});
    if(node.children) Object.entries(node.children).forEach(([k,n])=>collect(node,n,source,k));
  }
  Object.entries(data).forEach(([src,root])=>{ if(root.children) Object.entries(root.children).forEach(([k,n])=>collect(root,n,src,k)); });
  clearEl(treeEl);
  const back=document.createElement('div');
  back.className='item-row';
  appendIconLabel(back,'arrow-left','Back');
  back.addEventListener('click', renderTree);
  treeEl.appendChild(back);
  if(!items.length){ treeEl.appendChild(textEl('div','No items in this project','small')); return; }
  items.forEach(({node,container,key,source})=>{
    const row=document.createElement('div');
    row.className='item-row';
    const left=document.createElement('span');
    appendIconLabel(left, icon(node.type), key);
    const right=document.createElement('span');
    right.className='meta';
    right.textContent=String(source);
    row.appendChild(left);
    row.appendChild(right);
    row.addEventListener('click', ()=>selectItem(node,key,container,source,row));
    treeEl.appendChild(row);
  });
  clearEl(detailsCard);
  detailsCard.appendChild(textEl('strong','Project: '+String(project)));
  detailsCard.appendChild(document.createElement('br'));
  detailsCard.appendChild(document.createElement('br'));
  detailsCard.appendChild(textEl('div','Items found: '+String(items.length)));
  detailsCard.appendChild(document.createElement('br'));
  detailsCard.appendChild(textEl('div','Select an item for details.'));
  renderIcons(detailsCard);
}

let selected=null;
function selectItem(item,name,parentNode,connector,rowEl){
  selected={item,name,parentNode,connector,rowEl};
  document.querySelectorAll('.item-row').forEach((r)=>r.classList.remove('selected'));
  if(rowEl) rowEl.classList.add('selected');
  showDetails();
  updateActions();
}

function setDetailsEmpty(){
  clearEl(detailsCard);
  detailsCard.appendChild(textEl('div','Select an item to view details','small'));
}

function sanitizeUrl(raw){
  const value=String(raw||'').trim();
  if(!value) return '';
  try{
    const url=new URL(value, window.location.origin);
    if(url.protocol!=='http:' && url.protocol!=='https:') return '';
    return url.href;
  }catch{
    return '';
  }
}

function showDetails(){
  if(!selected){ setDetailsEmpty(); return; }
  const it=selected.item || {};
  clearEl(detailsCard);

  const titleWrap=document.createElement('div');
  const title=document.createElement('strong');
  title.textContent=String(selected.name);
  titleWrap.appendChild(title);

  const meta=document.createElement('div');
  meta.className='small';
  meta.textContent='Type: '+String(it.type||'item')+' â€¢ Project: '+String(it.project||'â€”')+' â€¢ Source: '+String(selected.connector||'â€”');

  const policy=document.createElement('div');
  policy.textContent='Approval: '+String(it.approvalState||'â€”')+' â€¢ Retention: '+String(it.retentionPolicy||'â€”')+' â€¢ Legal Hold: ';
  const legal=document.createElement('span');
  legal.textContent=it.legalHold ? 'YES' : 'No';
  if(it.legalHold) legal.className='legal-hold-yes';
  policy.appendChild(legal);

  const linkRow=document.createElement('div');
  const safeUrl=sanitizeUrl(it.url || '');
  if(safeUrl){
    const link=document.createElement('a');
    link.href=safeUrl;
    link.target='_blank';
    link.rel='noopener noreferrer';
    link.className='link-open';
    link.textContent='Open â†—';
    linkRow.appendChild(link);
  }else{
    linkRow.textContent='No external URL';
  }

  detailsCard.appendChild(titleWrap);
  detailsCard.appendChild(meta);
  detailsCard.appendChild(document.createElement('br'));
  detailsCard.appendChild(policy);
  detailsCard.appendChild(document.createElement('br'));
  detailsCard.appendChild(linkRow);
}

const modalBackdrop=document.getElementById('modalBackdrop');
const f_name=document.getElementById('f_name');
const f_type=document.getElementById('f_type');
const f_project=document.getElementById('f_project');
const f_url=document.getElementById('f_url');
const f_approval=document.getElementById('f_approval');
const f_retention=document.getElementById('f_retention');
const f_legal=document.getElementById('f_legal');
const f_tags=document.getElementById('f_tags');
let modalMode='new', modalParent=null;

function openModal(mode,parent){
  modalMode=mode;
  modalParent=parent||null;
  modalBackdrop.style.display='flex';
  if(mode==='new'){
    document.getElementById('modalTitle').textContent='Create item';
    f_name.value=''; f_type.value='document'; f_project.value=''; f_url.value=''; f_approval.value=''; f_retention.value=''; f_legal.checked=false; f_tags.value='';
  }else{
    document.getElementById('modalTitle').textContent='Edit item';
    f_name.value=selected.name; f_type.value=selected.item.type||'document'; f_project.value=selected.item.project||'';
    f_url.value=selected.item.url||''; f_approval.value=selected.item.approvalState||''; f_retention.value=selected.item.retentionPolicy||'';
    f_legal.checked=!!selected.item.legalHold; f_tags.value=(selected.item.complianceTags||[]).join(', ');
  }
  f_name.focus();
}

document.getElementById('modalCancel').onclick=()=>{ modalBackdrop.style.display='none'; };

document.getElementById('modalForm').addEventListener('submit', async (e)=>{
  e.preventDefault();
  const name=f_name.value.trim();
  if(!name){ alert('Name required'); return; }
  const attrs={
    type:f_type.value,
    project:f_project.value||undefined,
    url:sanitizeUrl(f_url.value)||undefined,
    approvalState:f_approval.value||undefined,
    retentionPolicy:f_retention.value||undefined,
    legalHold:f_legal.checked,
    complianceTags:f_tags.value ? f_tags.value.split(',').map((s)=>s.trim()).filter(Boolean) : []
  };

  if(modalMode==='new'){
    let parent=modalParent;
    if(!parent){
      if(selected && selected.item && selected.item.type==='folder') parent=selected.item;
      else {
        const conn=document.getElementById('connector').value||'Bookmarks';
        parent=data[conn] || (data[conn]={type:'root',children:{}});
      }
    }
    const res=await DataAPI.createItem({parentNode:parent,name,attrs});
    if(res){ modalBackdrop.style.display='none'; renderTree(); }
  }else{
    const newName = name!==selected.name ? name : undefined;
    const ok=await DataAPI.updateItem({target:selected,attrs,newName});
    if(ok){
      modalBackdrop.style.display='none';
      renderTree();
      if(newName) selected.name=newName;
      showDetails();
    }
  }
});

document.getElementById('newItemBtn').onclick=()=>{
  if(!ROLE_PERMS[currentRole].create){ alert('Permission denied: create'); return; }
  let parent=null;
  const conn=document.getElementById('connector').value;
  if(!data[conn]) data[conn]={type:'root',children:{}};
  parent=data[conn];
  openModal('new',parent);
};

document.getElementById('editBtn').onclick=()=>{
  if(!selected){ alert('Select item'); return; }
  if(!ROLE_PERMS[currentRole].edit){ alert('Permission denied: edit'); return; }
  openModal('edit');
};

document.getElementById('deleteBtn').onclick=async()=>{
  if(!selected){ alert('Select item'); return; }
  if(!ROLE_PERMS[currentRole].delete){ alert('Permission denied: delete'); return; }
  if(!confirm('Permanently delete "'+selected.name+'"?')) return;
  const ok=await DataAPI.deleteItem({target:selected});
  if(ok){
    selected=null;
    renderTree();
    setDetailsEmpty();
    updateActions();
  }
};

document.getElementById('copyBtn').onclick=async()=>{
  if(!selected) return;
  try{
    await navigator.clipboard.writeText(selected.item.url || selected.name);
    await logActionImmutable('COPIED',selected.name);
  }catch{
    alert('Copy failed');
  }
};

document.getElementById('openBtn').onclick=()=>{
  if(!selected) return;
  const it=selected.item || {};
  const safe = sanitizeUrl(it.url || '');
  if(safe) window.open(safe,'_blank','noopener');
  else if(it.type==='repo') window.open('https://github.com/'+String(selected.name),'_blank','noopener');
};

function updateActions(){
  const has=!!selected;
  const perms=ROLE_PERMS[currentRole]||ROLE_PERMS.Viewer;
  const safe = has ? sanitizeUrl(selected.item && selected.item.url || '') : '';
  document.getElementById('openBtn').disabled = !(has && !!safe);
  document.getElementById('copyBtn').disabled = !has;
  document.getElementById('editBtn').disabled = !(has && perms.edit);
  document.getElementById('deleteBtn').disabled = !(has && perms.delete);
}

function loadAudit(){
  clearEl(auditEl);
  if(!audit || !audit.length){
    auditEl.textContent='No activity yet';
    return;
  }
  audit.slice(-30).reverse().forEach((entry)=>{
    const line=document.createElement('div');
    const label = new Date(entry.time).toLocaleString() + ' â€” ' + String(entry.action || 'ACTION') + (entry.itemId ? ' â€” ' + String(entry.itemId) : '');
    line.textContent=label;
    auditEl.appendChild(line);
  });
}

function icon(t){ return t==='repo'?'github': t==='document'?'file-text': t==='record'?'file-check':'link'; }

document.getElementById('mode').addEventListener('change', renderTree);
document.getElementById('connector').addEventListener('change', renderTree);
document.getElementById('search').addEventListener('input', renderTree);

renderEnvSelect();
updateStatus();
renderTree();
setDetailsEmpty();
loadAudit();
updateChainStatus();
renderIcons();
hydrateLiveSources();

(async()=>{ if(audit.length && !(await verifyAuditChain())) alert('Audit chain integrity failed.'); })();
</script>
</body>
</html>
