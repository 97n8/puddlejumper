name: DB Backup

on:
  schedule:
    # Every 6 hours
    - cron: "0 */6 * * *"
  workflow_dispatch: # Allow manual trigger

jobs:
  backup:
    name: Backup SQLite databases
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Setup Fly CLI
        uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Run SQLite backup on Fly machine
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
        run: |
          set -euo pipefail
          APP="publiclogic-puddlejumper"
          TS=$(date -u +%Y%m%dT%H%M%SZ)
          DIR="/app/data/backups"

          flyctl ssh console --app "$APP" -C "mkdir -p ${DIR}"

          for db in prr connectors oauth_state; do
            echo "Backing up ${db}.db..."
            flyctl ssh console --app "$APP" -C "sqlite3 /app/data/${db}.db \".backup '${DIR}/${db}-${TS}.bak'\"" || echo "SKIP: ${db}.db not found"
          done

          flyctl ssh console --app "$APP" -C "ls -lh ${DIR}/"

      - name: Download backups from Fly
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
        run: |
          set -euo pipefail
          APP="publiclogic-puddlejumper"
          mkdir -p ./backups

          for db in prr connectors oauth_state; do
            LATEST=$(flyctl ssh console --app "$APP" -C "ls -t /app/data/backups/${db}-*.bak 2>/dev/null | head -1" | tr -d '\r')
            if [ -n "$LATEST" ]; then
              echo "Downloading $LATEST..."
              flyctl sftp get --app "$APP" "$LATEST" "./backups/$(basename "$LATEST")"
            fi
          done
          ls -lh ./backups/

      - name: Upload backup artifacts
        uses: actions/upload-artifact@v4
        with:
          name: db-backup-${{ github.run_id }}
          path: ./backups/
          retention-days: 30

      - name: Cleanup old backups on Fly
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
        run: |
          flyctl ssh console --app publiclogic-puddlejumper -C "find /app/data/backups -name '*.bak' -mtime +2 -delete 2>/dev/null; echo cleanup-done"
