name: CI

on:
  push:
    branches: ["main", "master"]
  pull_request:
    branches: ["main", "master"]

jobs:
  build-and-test:
    name: Build, lint, monorepo build & Docker smoke
    runs-on: ubuntu-latest
    timeout-minutes: 30
    defaults:
      run:
        working-directory: n8drive
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Enable corepack/pnpm
        run: |
          corepack enable
          corepack prepare pnpm@8.15.8 --activate
          pnpm --version

      - name: Setup Node.js 20.x
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"
          cache-dependency-path: n8drive/pnpm-lock.yaml

      - name: Install dependencies (frozen lockfile)
        run: pnpm install --frozen-lockfile

      - name: Clean stale TypeScript build cache
        run: find . -name "*.tsbuildinfo" -type f -delete

      - name: Build packages in dependency order
        run: |
          pnpm --filter @publiclogic/core run build
          pnpm --filter @publiclogic/logic-commons run build  
          pnpm --filter @publiclogic/puddlejumper run build

      - name: Lint frontend (if present)
        working-directory: n8drive/web
        if: ${{ hashFiles('n8drive/web/package.json') != '' }}
        run: |
          pnpm --filter web -w run -s lint || echo "No lint script or lint failed"

      - name: Typecheck (root)
        run: pnpm run typecheck

      - name: Contract check
        run: pnpm run check:pj-contract

      - name: Unit tests â€“ core
        run: pnpm --filter @publiclogic/core run test

      - name: Unit tests â€“ logic-commons
        run: pnpm --filter @publiclogic/logic-commons run test

      - name: Unit tests â€“ puddlejumper
        run: pnpm --filter @publiclogic/puddlejumper run test

      - name: Create CI env file
        run: |
          cat > .env.ci <<'EOF'
          NODE_ENV=production
          PORT=3002
          JWT_SECRET=ci-test-secret-min-32-chars-long-0000000000
          CONNECTOR_STATE_SECRET=ci-test-connector-secret
          ACCESS_NOTIFICATION_WEBHOOK_URL=http://localhost:9999/noop
          CONTROLLED_DATA_DIR=/app/data
          AUTH_ISSUER=ci-test-issuer
          AUTH_AUDIENCE=ci-test-audience
          PRR_DB_PATH=/app/data/prr.db
          CONNECTOR_DB_PATH=/app/data/connectors.db
          IDEMPOTENCY_DB_PATH=/app/data/idempotency.db
          RATE_LIMIT_DB_PATH=/app/data/ratelimit.db
          FRONTEND_URL=http://localhost:3000
          PJ_RUNTIME_CONTEXT_JSON={"workspace":{"id":"ci-workspace","name":"CI","charter":{"authority":true,"accountability":true,"boundary":true,"continuity":true}},"municipality":{"id":"ci-municipality","name":"CI Town","state":"MA"}}
          PJ_RUNTIME_TILES_JSON=[{"id":"ci-tile","label":"CI Tile","icon":"ğŸ”§","mode":"governed","intent":"deploy_policy","target":"ci-workspace","tone":"operational","description":"CI smoke test tile"}]
          PJ_RUNTIME_CAPABILITIES_JSON={"automations":[],"quickActions":[{"type":"action","trigger":["manual"],"title":"CI Action","icon":"ğŸ”§","desc":"CI quick action","hint":"Run CI action"}]}
          EOF
          sed -i 's/^[[:space:]]*//' .env.ci

      - name: Build Docker image
        run: |
          docker build -t publiclogic/puddlejumper:ci .

      - name: Run container for smoke test
        run: |
          docker rm -f pj-ci || true
          docker run -d --name pj-ci --env-file .env.ci -p 3002:3002 publiclogic/puddlejumper:ci
          echo "Waiting for /health (max 60s)..."
          for i in $(seq 1 60); do
            if curl -s -o /dev/null -w "%{http_code}" http://localhost:3002/health | grep -q 200; then
              echo "Health OK"
              exit 0
            fi
            sleep 1
          done
          echo "Health check failed; dumping container logs:"
          docker logs pj-ci --tail 200 || true
          docker rm -f pj-ci || true
          exit 1

      - name: Stop and cleanup container
        if: success()
        run: |
          docker logs pj-ci --tail 80 || true
          docker rm -f pj-ci || true

      - name: Upload docker image (optional)
        if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
        uses: docker/build-push-action@v4
        with:
          push: false
          tags: publiclogic/puddlejumper:ci
          context: n8drive
